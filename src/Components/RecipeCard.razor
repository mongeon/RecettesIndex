@using MudBlazor
@using RecettesIndex.Models
@using RecettesIndex.Services
@using RecettesIndex.Pages

<MudCard Elevation="0" Class="recipe-card" Outlined="true" Style="height: 100%; display: flex; flex-direction: column;">
    <div class="recipe-card-image" 
         style="@GetCardImageStyle()" 
         @onclick="@(() => OnView.InvokeAsync(Recipe))">
        <!-- Fun emoji/icon display -->
        <div class="recipe-visual">
            <MudIcon Icon="@GetRecipeIcon()" Size="Size.Large" Style="font-size: 72px; color: rgba(255,255,255,0.9);" />
        </div>
        
        <!-- Favorite Icon (Top Left) -->
        <div class="favorite-icon" @onclick:stopPropagation="true">
            <MudTooltip Text="@(IsFavorite ? "Retirer des favoris" : "Ajouter aux favoris")">
                <MudIconButton Icon="@(IsFavorite ? Icons.Material.Filled.Favorite : Icons.Material.Filled.FavoriteBorder)"
                              Color="@(IsFavorite ? Color.Error : Color.Default)"
                              Size="Size.Small"
                              OnClick="@(() => OnToggleFavorite.InvokeAsync(Recipe))"
                              Style="background-color: rgba(255,255,255,0.9); box-shadow: 0 2px 4px rgba(0,0,0,0.2);" />
            </MudTooltip>
        </div>
        
        <div class="recipe-rating-overlay">
            @if (Recipe.Rating > 0)
            {
                <MudChip T="string" Size="Size.Small" Color="@GetRatingColor()" Icon="@Icons.Material.Filled.LocalPizza">
                    @Recipe.Rating
                </MudChip>
            }
            else
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Dark" Icon="@Icons.Material.Filled.HelpOutline">
                    Non évaluée
                </MudChip>
            }
        </div>
    </div>
    
    <MudCardContent Class="flex-grow-1" Style="padding-bottom: 8px;">
        <MudText Typo="Typo.h6" Class="recipe-card-title" Style="margin-bottom: 8px; min-height: 48px;">
            @Recipe.Name
        </MudText>
        
        @if (Recipe.Rating > 0)
        {
            <div style="margin-bottom: 8px;">
                <PizzaRating Value="@Recipe.Rating" ReadOnly="true" Size="Size.Small" />
            </div>
        }
        
        <!-- Source Badges -->
        <MudStack Row Spacing="1" Class="mb-2">
            @if (Recipe.IsFromBook && Book != null)
            {
                <MudChip T="string" 
                         Size="Size.Small" 
                         Icon="@Icons.Material.Filled.MenuBook" 
                         Color="Color.Primary"
                         Variant="Variant.Filled">
                    @Book.Name
                </MudChip>
                @if (Recipe.BookPage.HasValue)
                {
                    <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.BookmarkBorder" Color="Color.Default">
                        p. @Recipe.BookPage
                    </MudChip>
                }
            }
            else if (Recipe.IsFromStore && (Store != null || Recipe.Store != null))
            {
                var storeToDisplay = Store ?? Recipe.Store;
                <MudChip T="string" 
                         Size="Size.Small" 
                         Icon="@Icons.Material.Filled.Storefront" 
                         Color="Color.Secondary"
                         Variant="Variant.Filled">
                    @storeToDisplay?.Name
                </MudChip>
            }
            else
            {
                <MudChip T="string" 
                         Size="Size.Small" 
                         Icon="@Icons.Material.Filled.Home" 
                         Color="Color.Tertiary"
                         Variant="Variant.Filled">
                    Maison
                </MudChip>
            }
        </MudStack>
        
        @if (!string.IsNullOrWhiteSpace(Recipe.Notes))
        {
            var preview = Recipe.Notes.Length > 80 ? Recipe.Notes.Substring(0, 80) + "..." : Recipe.Notes;
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2" Style="font-size: 0.875rem; line-height: 1.4;">
                @preview
            </MudText>
        }
    </MudCardContent>
    
    <MudDivider />
    
    <MudCardActions Class="d-flex justify-space-between pa-2">
        <MudButtonGroup Size="Size.Small" Variant="Variant.Text">
            <MudTooltip Text="Voir les détails">
                <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                              Color="Color.Primary"
                              Size="Size.Small"
                              OnClick="@(() => OnView.InvokeAsync(Recipe))" />
            </MudTooltip>
            
            <MudTooltip Text="Imprimer">
                <MudIconButton Icon="@Icons.Material.Filled.Print" 
                              Color="Color.Default"
                              Size="Size.Small"
                              OnClick="@(() => OnPrint.InvokeAsync(Recipe))" />
            </MudTooltip>
            
            @if (IsAuthenticated)
            {
                <MudTooltip Text="Modifier">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                  Color="Color.Secondary"
                                  Size="Size.Small"
                                  OnClick="@(() => OnEdit.InvokeAsync(Recipe))" />
                </MudTooltip>
                
                <MudTooltip Text="Supprimer">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                  Color="Color.Error"
                                  Size="Size.Small"
                                  OnClick="@(() => OnDelete.InvokeAsync(Recipe))" />
                </MudTooltip>
            }
        </MudButtonGroup>
        
        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-size: 0.75rem;">
            @GetRelativeDate(Recipe.CreationDate)
        </MudText>
    </MudCardActions>
</MudCard>

@code {
    [Parameter, EditorRequired]
    public Recipe Recipe { get; set; } = null!;
    
    [Parameter]
    public Book? Book { get; set; }
    
    [Parameter]
    public Store? Store { get; set; }
    
    [Parameter]
    public bool IsAuthenticated { get; set; }
    
    [Parameter]
    public bool IsFavorite { get; set; }
    
    [Parameter]
    public EventCallback<Recipe> OnView { get; set; }
    
    [Parameter]
    public EventCallback<Recipe> OnEdit { get; set; }
    
    [Parameter]
    public EventCallback<Recipe> OnDelete { get; set; }
    
    [Parameter]
    public EventCallback<Recipe> OnPrint { get; set; }
    
    [Parameter]
    public EventCallback<Recipe> OnToggleFavorite { get; set; }

    private string GetRelativeDate(DateTime date)
    {
        var span = DateTime.UtcNow - date;
        if (span.TotalDays < 1) return "Aujourd'hui";
        if (span.TotalDays < 2) return "Hier";
        if (span.TotalDays < 7) return $"Il y a {(int)span.TotalDays}j";
        if (span.TotalDays < 30) return $"Il y a {(int)(span.TotalDays / 7)} sem.";
        if (span.TotalDays < 365) return date.ToString("MMM yyyy");
        return date.ToString("dd MMM yyyy");
    }

    private Color GetRatingColor() => Recipe.Rating switch
    {
        5 => Color.Success,
        4 => Color.Info,
        3 => Color.Warning,
        2 => Color.Default,
        1 => Color.Error,
        _ => Color.Dark
    };
    
    private string GetCardImageStyle()
    {
        var gradient = Recipe.Rating switch
        {
            5 => "linear-gradient(135deg, var(--mud-palette-success) 0%, var(--mud-palette-success-lighten) 100%)",
            4 => "linear-gradient(135deg, var(--mud-palette-info) 0%, var(--mud-palette-info-lighten) 100%)",
            3 => "linear-gradient(135deg, var(--mud-palette-warning) 0%, var(--mud-palette-warning-lighten) 100%)",
            2 => "linear-gradient(135deg, #9E9E9E 0%, #BDBDBD 100%)",
            1 => "linear-gradient(135deg, var(--mud-palette-error) 0%, var(--mud-palette-error-lighten) 100%)",
            _ => "linear-gradient(135deg, #757575 0%, #9E9E9E 100%)"
        };
        
        return $"height: 140px; position: relative; display: flex; align-items: center; justify-content: center; background: {gradient}; overflow: hidden; cursor: pointer;";
    }
    
    private string GetRecipeIcon()
    {
        // Use recipe name hash to deterministically assign an icon
        var hash = Math.Abs(Recipe.Name.GetHashCode());
        
        // Array of fun food-related Material Design icons
        var foodIcons = new[]
        {
            Icons.Material.Filled.Restaurant,      // Fork & knife
            Icons.Material.Filled.LocalPizza,      // Pizza
            Icons.Material.Filled.LunchDining,     // Burger
            Icons.Material.Filled.Cake,            // Cake
            Icons.Material.Filled.Icecream,        // Ice cream
            Icons.Material.Filled.LocalBar,        // Cocktail
            Icons.Material.Filled.Coffee,          // Coffee
            Icons.Material.Filled.EmojiFoodBeverage, // Hot drink
            Icons.Material.Filled.Egg,             // Egg
            Icons.Material.Filled.BakeryDining,    // Bread
            Icons.Material.Filled.RamenDining,     // Ramen
            Icons.Material.Filled.Fastfood,        // Fast food
            Icons.Material.Filled.DinnerDining,    // Dinner plate
            Icons.Material.Filled.BreakfastDining, // Breakfast
            Icons.Material.Filled.BrunchDining,    // Brunch
            Icons.Material.Filled.SoupKitchen,     // Soup
            Icons.Material.Filled.SetMeal,         // Set meal
            Icons.Material.Filled.RiceBowl,        // Rice bowl
            Icons.Material.Filled.FreeBreakfast,   // Toast
            Icons.Material.Filled.Tapas            // Tapas
        };
        
        // Select icon based on hash (ensures same recipe always gets same icon)
        return foodIcons[hash % foodIcons.Length];
    }
}
