@using MudBlazor
@using RecettesIndex.Models

<MudExpansionPanels Class="mb-3">
    <MudExpansionPanel Text="Filtres Avanc√©s" 
                      Icon="@Icons.Material.Filled.FilterList">
        <TitleContent>
            <div class="d-flex align-center">
                <MudIcon Icon="@Icons.Material.Filled.FilterList" Class="mr-2" />
                <MudText>Filtres Avanc√©s</MudText>
                @if (ActiveFilterCount > 0)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Class="ml-2">
                        @ActiveFilterCount
                    </MudChip>
                }
            </div>
        </TitleContent>
        <ChildContent>
            <MudStack Spacing="3" Class="mt-2">
                <!-- Search -->
                <MudTextField T="string" 
                              Value="@SearchTerm" 
                              ValueChanged="OnSearchChanged" 
                              Placeholder="Rechercher des recettes..." 
                              Adornment="Adornment.Start" 
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Clearable="true"
                              Immediate="false"
                              DebounceInterval="300"
                              HelperText="Recherchez par nom de recette"
                              Variant="Variant.Outlined" />
                
                <!-- Filter Row -->
                <MudGrid Spacing="2">
                    <MudItem xs="12" sm="6" md="3">
                    <MudSelect T="string" 
                               Value="@RatingFilter" 
                               ValueChanged="OnRatingChanged" 
                               Clearable="true" 
                               Label="√âvaluation" 
                               FullWidth="true"
                               Variant="Variant.Outlined">
                        <MudSelectItem T="string" Value='@("all")'>Toutes</MudSelectItem>
                        <MudSelectItem T="string" Value='@("1")'>üçï 1</MudSelectItem>
                        <MudSelectItem T="string" Value='@("2")'>üçï 2</MudSelectItem>
                        <MudSelectItem T="string" Value='@("3")'>üçï 3</MudSelectItem>
                        <MudSelectItem T="string" Value='@("4")'>üçï 4</MudSelectItem>
                        <MudSelectItem T="string" Value='@("5")'>üçï 5</MudSelectItem>
                    </MudSelect>
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="3">
                    <MudSelect T="string" 
                               Value="@BookFilter" 
                               ValueChanged="OnBookChanged" 
                               Clearable="true" 
                               Label="Livre" 
                               FullWidth="true"
                               Variant="Variant.Outlined">
                        <MudSelectItem T="string" Value='@("all")'>Tous (@Books.Count)</MudSelectItem>
                        @foreach (var b in Books)
                        {
                            var recipeCount = GetRecipeCountForBook(b.Id);
                            <MudSelectItem T="string" Value="@b.Id.ToString()">@b.Name (@recipeCount)</MudSelectItem>
                        }
                    </MudSelect>
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="3">
                    <MudSelect T="string" 
                               Value="@StoreFilter" 
                               ValueChanged="OnStoreChanged" 
                               Clearable="true" 
                               Label="Magasin/Restaurant" 
                               FullWidth="true"
                               Variant="Variant.Outlined">
                        <MudSelectItem T="string" Value='@("all")'>Tous (@Stores.Count)</MudSelectItem>
                        @foreach (var s in Stores)
                        {
                            var recipeCount = GetRecipeCountForStore(s.Id);
                            <MudSelectItem T="string" Value="@s.Id.ToString()">@s.Name (@recipeCount)</MudSelectItem>
                        }
                    </MudSelect>
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="3">
                    <MudSelect T="string" 
                               Value="@AuthorFilter" 
                               ValueChanged="OnAuthorChanged" 
                               Clearable="true" 
                               Label="Auteur" 
                               FullWidth="true"
                               Variant="Variant.Outlined">
                        <MudSelectItem T="string" Value='@("all")'>Tous (@Authors.Count)</MudSelectItem>
                        @foreach (var a in Authors)
                        {
                            var recipeCount = GetRecipeCountForAuthor(a.Id);
                            <MudSelectItem T="string" Value="@a.Id.ToString()">@a.FullName (@recipeCount)</MudSelectItem>
                        }
                    </MudSelect>
                    </MudItem>
                </MudGrid>
                
                <!-- Filter Actions -->
                @if (ActiveFilterCount > 0)
                {
                    <MudStack Row Spacing="1" Class="mt-2">
                        <MudButton Variant="Variant.Outlined" 
                                  Color="Color.Error" 
                                  Size="Size.Small"
                                  StartIcon="@Icons.Material.Filled.Clear"
                                  OnClick="OnClearAllFilters">
                            Tout effacer
                        </MudButton>
                    </MudStack>
                }
            </MudStack>
        </ChildContent>
    </MudExpansionPanel>
</MudExpansionPanels>

@code {
    [Parameter, EditorRequired] public string SearchTerm { get; set; } = string.Empty;
    [Parameter, EditorRequired] public string? RatingFilter { get; set; }
    [Parameter, EditorRequired] public string? BookFilter { get; set; }
    [Parameter, EditorRequired] public string? StoreFilter { get; set; }
    [Parameter, EditorRequired] public string? AuthorFilter { get; set; }
    [Parameter, EditorRequired] public int ActiveFilterCount { get; set; }
    
    [Parameter, EditorRequired] public List<Book> Books { get; set; } = new();
    [Parameter, EditorRequired] public List<Store> Stores { get; set; } = new();
    [Parameter, EditorRequired] public List<Author> Authors { get; set; } = new();
    [Parameter, EditorRequired] public Dictionary<int, int> BookRecipeCounts { get; set; } = new();
    [Parameter, EditorRequired] public Dictionary<int, int> StoreRecipeCounts { get; set; } = new();
    [Parameter, EditorRequired] public Dictionary<int, int> AuthorRecipeCounts { get; set; } = new();
    
    [Parameter, EditorRequired] public EventCallback<string> OnSearchChanged { get; set; }
    [Parameter, EditorRequired] public EventCallback<string?> OnRatingChanged { get; set; }
    [Parameter, EditorRequired] public EventCallback<string?> OnBookChanged { get; set; }
    [Parameter, EditorRequired] public EventCallback<string?> OnStoreChanged { get; set; }
    [Parameter, EditorRequired] public EventCallback<string?> OnAuthorChanged { get; set; }
    [Parameter, EditorRequired] public EventCallback OnClearAllFilters { get; set; }
    
    private int GetRecipeCountForBook(int bookId) => BookRecipeCounts.GetValueOrDefault(bookId, 0);
    private int GetRecipeCountForStore(int storeId) => StoreRecipeCounts.GetValueOrDefault(storeId, 0);
    private int GetRecipeCountForAuthor(int authorId) => AuthorRecipeCounts.GetValueOrDefault(authorId, 0);
}
