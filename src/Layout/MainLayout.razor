@using RecettesIndex.Pages
@inherits LayoutComponentBase
@implements IDisposable
@using RecettesIndex.Services
@inject AuthService AuthService
@inject MudBlazor.IDialogService DialogService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject RecettesIndex.Services.Abstractions.IErrorLoggingService ErrorLoggingService

<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="@_currentTheme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>
    <MudAppBar Elevation="0" Color="Color.Primary" Dense="false">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <MudText Typo="Typo.h6" Class="ml-2 d-none d-sm-flex" Style="font-weight: 700; letter-spacing: -0.5px;">Mes Recettes</MudText>
        <MudSpacer />
        
        <MudTooltip Text="Basculer en mode sombre">
            <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" 
                          Color="Color.Inherit" 
                          OnClick="@ToggleDarkMode" />
        </MudTooltip>
        
        @if (!AuthService.IsAuthenticated)
        {
            <MudButton Variant="Variant.Outlined" Color="Color.Inherit" Size="Size.Small" 
                       Class="d-none d-sm-flex ml-1" OnClick="ShowSignInDialog">Se connecter</MudButton>
            <MudIconButton Icon="@Icons.Material.Filled.Login" Color="Color.Inherit" 
                           Class="d-flex d-sm-none" OnClick="ShowSignInDialog" />
        }
        else
        {
            <MudMenu Dense="true" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" Class="ml-1">
                <ActivatorContent>
                    <MudTooltip Text="@AuthService.UserEmail">
                        <MudAvatar Color="Color.Secondary" Size="Size.Small" Style="cursor: pointer; font-size: 0.85rem; font-weight: 700;">
                            @GetUserInitials(AuthService.UserEmail)
                        </MudAvatar>
                    </MudTooltip>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem Disabled="true">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@AuthService.UserEmail</MudText>
                    </MudMenuItem>
                    <MudDivider />
                    <MudMenuItem OnClick="SignOut" Icon="@Icons.Material.Filled.Logout">
                        Se déconnecter
                    </MudMenuItem>
                </ChildContent>
            </MudMenu>
        }
    </MudAppBar>
    
    <MudDrawer @bind-Open="_drawerOpen" Elevation="0" ClipMode="DrawerClipMode.Always"
               Variant="DrawerVariant.Responsive" Breakpoint="Breakpoint.Md"
               Style="border-right: 1px solid var(--mud-palette-divider);">
        <NavMenu />
    </MudDrawer>
    
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4 px-4">
            <ErrorBoundary @ref="_errorBoundary">
                <ChildContent>
                    <div class="page-enter" @key="NavigationKey">
                        @Body
                    </div>
                </ChildContent>
                <ErrorContent Context="ex">
                    @{ _ = ErrorLoggingService.LogErrorAsync(ex, NavigationManager.Uri); }
                    <MudContainer MaxWidth="MaxWidth.Small" Class="mt-16 text-center">
                        <MudIcon Icon="@Icons.Material.Filled.ErrorOutline" Color="Color.Error" Style="font-size: 4rem;" />
                        <MudText Typo="Typo.h5" Class="mt-4">Oups, quelque chose s'est mal passé</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">@ex.Message</MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ResetError">
                            Réessayer
                        </MudButton>
                    </MudContainer>
                </ErrorContent>
            </ErrorBoundary>
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private bool _isDarkMode;
    private string _currentPath = string.Empty;
    private ErrorBoundary? _errorBoundary;
    
    // Define light and dark themes
    private MudTheme _currentTheme = new MudTheme
    {
        PaletteLight = new PaletteLight
        {
            Primary = "#FF6B6B",
            Secondary = "#4ECDC4",
            Background = "#F7F5F3",
            Surface = "#FFFFFF",
            AppbarBackground = "#FF6B6B",
            DrawerBackground = "#F7F5F3",
            DrawerText = "#474747",
            Success = "#6BCB77",
            TextPrimary = "#333333",
            TextSecondary = "#666666",
            PrimaryContrastText = "#ffffff",
            SecondaryContrastText = "#ffffff"
        },
        PaletteDark = new PaletteDark
        {
            Primary = "#FF6B6B",
            Secondary = "#4ECDC4",
            Tertiary = "#FFD166",
            Background = "#1A1A1A",
            Surface = "#242424",
            AppbarBackground = "#272727",
            DrawerBackground = "#1E1E1E",
            DrawerText = "#DDDDDD",
            Success = "#6BCB77",
            Warning = "#F4A261",
            Info = "#5BC4BF",
            Error = "#FF6B6B",
            TextPrimary = "#EEEEEE",
            TextSecondary = "#AAAAAA"
        },
        LayoutProperties = new LayoutProperties
        {
            DefaultBorderRadius = "12px"
        },
        Typography = new Typography
        {
            Default = new DefaultTypography
            {
                FontFamily = new[] { "Nunito", "Helvetica", "Arial", "sans-serif" },
                FontSize = "1rem",
                FontWeight = "400",
                LineHeight = "1.6"
            },
            H1 = new H1Typography
            {
                FontFamily = new[] { "Nunito", "Helvetica", "Arial", "sans-serif" },
                FontSize = "2.5rem",
                FontWeight = "700",
                LineHeight = "1.2"
            },
            H2 = new H2Typography
            {
                FontFamily = new[] { "Nunito", "Helvetica", "Arial", "sans-serif" },
                FontSize = "2rem",
                FontWeight = "700",
                LineHeight = "1.25"
            },
            H3 = new H3Typography
            {
                FontFamily = new[] { "Nunito", "Helvetica", "Arial", "sans-serif" },
                FontSize = "1.75rem",
                FontWeight = "700",
                LineHeight = "1.3"
            },
            H4 = new H4Typography
            {
                FontFamily = new[] { "Nunito", "Helvetica", "Arial", "sans-serif" },
                FontSize = "1.5rem",
                FontWeight = "600",
                LineHeight = "1.35"
            },
            H5 = new H5Typography
            {
                FontFamily = new[] { "Nunito", "Helvetica", "Arial", "sans-serif" },
                FontSize = "1.25rem",
                FontWeight = "600",
                LineHeight = "1.4"
            },
            H6 = new H6Typography
            {
                FontFamily = new[] { "Nunito", "Helvetica", "Arial", "sans-serif" },
                FontSize = "1.125rem",
                FontWeight = "600",
                LineHeight = "1.4"
            },
            Body1 = new Body1Typography
            {
                FontFamily = new[] { "Nunito", "Helvetica", "Arial", "sans-serif" },
                FontSize = "1rem",
                FontWeight = "400",
                LineHeight = "1.6"
            },
            Body2 = new Body2Typography
            {
                FontFamily = new[] { "Nunito", "Helvetica", "Arial", "sans-serif" },
                FontSize = "0.875rem",
                FontWeight = "400",
                LineHeight = "1.57"
            }
        }
    };
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await AuthService.InitializeAsync();

            // Load user's theme preference from local storage
            var storedTheme = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "recipes-theme-preference");
            _isDarkMode = storedTheme == "dark";
            StateHasChanged();
        }
    }

    private string NavigationKey => NavigationManager.Uri;

    protected override void OnInitialized()
    {
        AuthService.AuthStateChanged += OnAuthStateChanged;
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        _errorBoundary?.Recover();
    }

    private void ResetError()
    {
        _errorBoundary?.Recover();
    }
    
    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }
    
    private async Task ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
        // Save the user's preference to local storage
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "recipes-theme-preference", _isDarkMode ? "dark" : "light");
    }

    private async Task ShowSignInDialog()
    {
        var options = new MudBlazor.DialogOptions { CloseButton = true, MaxWidth = MudBlazor.MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<SignInDialog>("Connexion", options);
        await dialog.Result;
    }

    private async Task SignOut()
    {
        await AuthService.SignOutAsync();
    }

    private void OnAuthStateChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private string GetUserInitials(string? email)
    {
        if (string.IsNullOrWhiteSpace(email)) return "?";
        var name = email.Split('@')[0];
        var parts = name.Split('.', '-', '_');
        if (parts.Length == 1) return name.Substring(0, 1).ToUpper();
        return string.Concat(parts.Select(p => p.Length > 0 ? char.ToUpper(p[0]) : '?')).Substring(0, Math.Min(2, parts.Count()));
    }

    public void Dispose()
    {
        AuthService.AuthStateChanged -= OnAuthStateChanged;
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
