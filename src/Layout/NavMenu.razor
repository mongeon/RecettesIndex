@using RecettesIndex.Services
@using RecettesIndex.Pages
@inject LocalStorageService LocalStorage
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject AuthService AuthService
@inject ISnackbar Snackbar
@implements IDisposable

<MudNavMenu>
    <div class="d-flex justify-center py-4">
        <MudImage Src="/icons/recipe-icon.svg" Alt="Logo" Width="60" Height="60" Class="mt-4 mb-3" />
    </div>
    
    <MudDivider Class="mb-2" />
    
    <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">
        Accueil
    </MudNavLink>
    <MudNavLink Href="dashboard" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Dashboard">
        Tableau de Bord
    </MudNavLink>
    <MudNavLink Href="recipes" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.MenuBook">
        Recettes
    </MudNavLink>
    <MudNavLink Href="books" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.LibraryBooks">
        Livres
    </MudNavLink>
    <MudNavLink Href="stores" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Storefront">
        Magasins
    </MudNavLink>
    <MudNavLink Href="authors" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Person">
        Auteurs
    </MudNavLink>
    
    <!-- Recent Recipes Dropdown -->
    @if (recentRecipes.Any())
    {
        <MudDivider Class="my-2" />
        
        <MudMenu Icon="@Icons.Material.Filled.History" 
                 IconColor="Color.Primary"
                 Dense="true"
                 FullWidth="true"
                 Class="px-4">
            <ActivatorContent>
                <div class="d-flex align-center justify-space-between" style="width: 100%;">
                    <div class="d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-3" />
                        <MudText>Récentes</MudText>
                    </div>
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary">@recentRecipes.Count</MudChip>
                </div>
            </ActivatorContent>
            <ChildContent>
                @foreach (var recent in recentRecipes)
                {
                    <MudMenuItem OnClick="@(() => NavigateToRecipe(recent.Id))">
                        <div class="d-flex flex-column" style="min-width: 200px;">
                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@recent.Name</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @GetRelativeTime(recent.ViewedAt)
                            </MudText>
                        </div>
                    </MudMenuItem>
                }
                <MudDivider Class="my-1" />
                <MudMenuItem OnClick="ClearRecentRecipes">
                    <div class="d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Filled.Clear" Size="Size.Small" Class="mr-2" Color="Color.Error" />
                        <MudText Typo="Typo.body2" Color="Color.Error">Effacer l'historique</MudText>
                    </div>
                </MudMenuItem>
            </ChildContent>
        </MudMenu>
    }
    
    <MudSpacer />
    <MudDivider Class="mb-2" />
    
    @if (AuthService.IsAuthenticated)
    {
        <div class="px-3 mb-3">
            <MudButton FullWidth="true"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="ShowAddRecipeDialog"
                       Style="justify-content: flex-start;">
                Ajouter une recette
            </MudButton>
        </div>
    }
</MudNavMenu>

@code {
    private async Task ShowAddRecipeDialog()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AddRecipeDialog>("Ajouter une recette", options);
        var result = await dialog.Result;
        if (result is not null && !result.Canceled)
        {
            Snackbar.Add("Recette ajoutée avec succès!", Severity.Success);
        }
    }

    private List<RecentRecipe> recentRecipes = new();


    protected override async Task OnInitializedAsync()
    {
        await LoadRecentRecipes();
        
        // Subscribe to navigation and auth changes
        NavigationManager.LocationChanged += OnLocationChanged;
        AuthService.AuthStateChanged += OnAuthStateChanged;
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // Refresh recent recipes when navigation occurs
        await LoadRecentRecipes();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadRecentRecipes()
    {
        try
        {
            recentRecipes = await LocalStorage.GetRecentRecipesAsync();
        }
        catch
        {
            recentRecipes = new List<RecentRecipe>();
        }
    }

    private void NavigateToRecipe(int recipeId)
    {
        NavigationManager.NavigateTo($"/recipes/{recipeId}");
    }

    private async Task ClearRecentRecipes()
    {
        await LocalStorage.ClearRecentRecipesAsync();
        recentRecipes = new List<RecentRecipe>();
        StateHasChanged();
    }

    private string GetRelativeTime(DateTime viewedAt)
    {
        var timeSpan = DateTime.UtcNow - viewedAt;
        
        if (timeSpan.TotalMinutes < 1)
            return "À l'instant";
        if (timeSpan.TotalMinutes < 60)
            return $"Il y a {(int)timeSpan.TotalMinutes} min";
        if (timeSpan.TotalHours < 24)
            return $"Il y a {(int)timeSpan.TotalHours}h";
        if (timeSpan.TotalDays < 7)
            return $"Il y a {(int)timeSpan.TotalDays}j";
        if (timeSpan.TotalDays < 30)
            return $"Il y a {(int)(timeSpan.TotalDays / 7)} sem";
        
        return viewedAt.ToString("dd MMM");
    }

    private void OnAuthStateChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        AuthService.AuthStateChanged -= OnAuthStateChanged;
    }
}
