@using Microsoft.AspNetCore.Components
@using MudBlazor
@using RecettesIndex.Models
@using RecettesIndex.Services.Abstractions
@using Microsoft.Extensions.Logging
@inject IRecipeService RecipeService
@inject ISnackbar Snackbar
@inject ILogger<EditRecipeDialog> Logger

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6">Modifier la Recette</MudText>
        <MudTextField @bind-Value="recipe.Name" Label="Nom" Required="true" Variant="Variant.Outlined" Class="mb-2" />
        <PizzaRating @bind-Value="recipe.Rating" ReadOnly="false" />
        <MudTextField @bind-Value="recipe.Notes" Label="Notes" Variant="Variant.Outlined" Class="mb-2" />
        <MudNumericField @bind-Value="recipe.BookPage" Label="Page du livre (optionnel)" Variant="Variant.Outlined" Class="mb-2" />
        <MudSelect T="Book" Label="Livre (optionnel)" @bind-Value="selectedBook" Variant="Variant.Outlined" Class="mb-2">
            <MudSelectItem T="Book" Value="null">Aucun</MudSelectItem>
            @foreach (var book in books)
            {
                <MudSelectItem T="Book" Value="book">@book.Name</MudSelectItem>
            }
        </MudSelect>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error">@errorMessage</MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="SaveAsync" Color="Color.Primary" Variant="Variant.Filled" Disabled="@isSaving">
            @if (isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
            }
            else
            {
                <span>Enregistrer</span>
            }
        </MudButton>
        <MudButton OnClick="Cancel" Color="Color.Secondary" Variant="Variant.Text" Disabled="@isSaving">Annuler</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] 
    public Recipe RecipeToEdit { get; set; } = new();

    [CascadingParameter]
    public required IMudDialogInstance MudDialog { get; set; }
    
    private Recipe recipe = new();
    private string? errorMessage;
    private List<Book> books = [];
    private Book? selectedBook;
    private bool isSaving = false;
    
    protected override async Task OnInitializedAsync()
    {
        // Use service layer with caching instead of direct Supabase client
        books = (await RecipeService.GetBooksAsync())?.ToList() ?? [];
        
        // Set the initial values for editing
        recipe = new Recipe
        {
            Id = RecipeToEdit.Id,
            Name = RecipeToEdit.Name,
            Rating = RecipeToEdit.Rating,
            Notes = RecipeToEdit.Notes,
            BookId = RecipeToEdit.BookId,
            BookPage = RecipeToEdit.BookPage,
            CreationDate = RecipeToEdit.CreationDate
        };
        
        selectedBook = books.FirstOrDefault(b => b.Id == RecipeToEdit.BookId);
    }
    
    private async Task SaveAsync()
    {
        errorMessage = null;
        isSaving = true;
        
        try
        {
            // Validate input
            if (string.IsNullOrWhiteSpace(recipe.Name))
            {
                errorMessage = "Le nom de la recette est requis.";
                isSaving = false;
                return;
            }

            // Update book reference
            recipe.BookId = selectedBook?.Id;
            
            // Use service layer for update
            var result = await RecipeService.UpdateAsync(recipe);
            
            if (result.IsSuccess)
            {
                Snackbar.Add("Recette modifiée avec succès!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(result.Value));
            }
            else
            {
                errorMessage = result.ErrorMessage ?? "Échec lors de la mise à jour de la recette.";
                Snackbar.Add(errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Unexpected error updating recipe");
            errorMessage = "Une erreur inattendue s'est produite.";
            Snackbar.Add(errorMessage, Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }
    
    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
