@using Microsoft.AspNetCore.Components
@using MudBlazor
@using RecettesIndex.Models
@using RecettesIndex.Services.Abstractions
@using Microsoft.Extensions.Logging
@inject IRecipeService RecipeService
@inject ISnackbar Snackbar
@inject ILogger<EditRecipeDialog> Logger

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6">Modifier la Recette</MudText>
        
        <MudTextField @bind-Value="recipe.Name" 
                      Label="Nom" 
                      Required="true" 
                      Variant="Variant.Outlined" 
                      Class="mb-3" />
        
        <PizzaRating @bind-Value="recipe.Rating" ReadOnly="false" />
        
        <MudTextField @bind-Value="recipe.Notes" 
                      Label="Notes" 
                      Variant="Variant.Outlined" 
                      Class="mb-3" 
                      Lines="3" />
        
        <!-- Source Selection Toggle -->
        <MudText Typo="Typo.subtitle2" Class="mb-2">Source de la recette:</MudText>
        <MudRadioGroup T="string" 
                       @bind-Value="sourceType"
                       Class="mb-3">
            <MudRadio T="string" Value="@("book")" Color="Color.Primary" Class="mb-2">
                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.MenuBook" Size="Size.Small" />
                    <span>Livre de recettes</span>
                </MudStack>
            </MudRadio>
            <MudRadio T="string" Value="@("store")" Color="Color.Secondary" Class="mb-2">
                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.Storefront" Size="Size.Small" />
                    <span>Magasin/Restaurant</span>
                </MudStack>
            </MudRadio>
            <MudRadio T="string" Value="@("url")" Color="Color.Tertiary" Class="mb-2">
                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.Language" Size="Size.Small" />
                    <span>Site Web</span>
                </MudStack>
            </MudRadio>
            <MudRadio T="string" Value="@("none")" Color="Color.Default">
                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" />
                    <span>Aucune source</span>
                </MudStack>
            </MudRadio>
        </MudRadioGroup>
        
        <!-- Book Selection (shown when sourceType is "book") -->
        @if (sourceType == "book")
        {
            <MudPaper Class="pa-3 mb-3" Elevation="0" Style="background-color: #e3f2fd;" @key="@($"book-{sourceType}")">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">
                        <MudIcon Icon="@Icons.Material.Filled.MenuBook" Size="Size.Small" Class="mr-1" />
                        Informations du livre
                    </MudText>
                    <MudSelect T="Book" 
                               Label="Livre *" 
                               @bind-Value="selectedBook" 
                               Variant="Variant.Outlined"
                               ToStringFunc="@(b => b?.Name ?? "Sélectionner un livre...")">
                        @foreach (var book in books)
                        {
                            <MudSelectItem T="Book" Value="@book">@book.Name</MudSelectItem>
                        }
                    </MudSelect>
                    <MudNumericField @bind-Value="recipe.BookPage" 
                                     Label="Page du livre" 
                                     Variant="Variant.Outlined" 
                                     Min="1" />
                </MudStack>
            </MudPaper>
        }
        
        <!-- Store Selection (shown when sourceType is "store") -->
        @if (sourceType == "store")
        {
            <MudPaper Class="pa-3 mb-3" Elevation="0" Style="background-color: #fff3e0;" @key="@($"store-{sourceType}")">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">
                        <MudIcon Icon="@Icons.Material.Filled.Storefront" Size="Size.Small" Class="mr-1" />
                        Informations du magasin/restaurant
                    </MudText>
                    <MudSelect T="Store" 
                               Label="Magasin ou Restaurant *" 
                               @bind-Value="selectedStore" 
                               Variant="Variant.Outlined"
                               ToStringFunc="@(s => s?.Name ?? "Sélectionner un magasin...")">
                        @foreach (var store in stores)
                        {
                            <MudSelectItem T="Store" Value="@store">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.Storefront" Size="Size.Small" />
                                    <span>@store.Name</span>
                                </MudStack>
                            </MudSelectItem>
                        }
                    </MudSelect>
                </MudStack>
            </MudPaper>
        }
        
        <!-- URL Selection (shown when sourceType is "url") -->
        @if (sourceType == "url")
        {
            <MudPaper Class="pa-3 mb-3" Elevation="0" Style="background-color: #e8f5e8;" @key="@($"url-{sourceType}")">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Tertiary">
                        <MudIcon Icon="@Icons.Material.Filled.Language" Size="Size.Small" Class="mr-1" />
                        Informations du site web
                    </MudText>
                    <MudTextField @bind-Value="recipe.Url" 
                                  Label="URL du site web *" 
                                  Variant="Variant.Outlined" 
                                  Placeholder="https://example.com/recipe" />
                </MudStack>
            </MudPaper>
        }
        
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mt-2">@errorMessage</MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="SaveAsync" 
                   Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   Disabled="@isSaving"
                   StartIcon="@Icons.Material.Filled.Save">
            @if (isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                <span class="ml-2">Enregistrement...</span>
            }
            else
            {
                <span>Enregistrer</span>
            }
        </MudButton>
        <MudButton OnClick="Cancel" 
                   Color="Color.Secondary" 
                   Variant="Variant.Text" 
                   Disabled="@isSaving">
            Annuler
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] 
    public Recipe RecipeToEdit { get; set; } = new();

    [CascadingParameter]
    public required IMudDialogInstance MudDialog { get; set; }
    
    private Recipe recipe = new();
    private string? errorMessage;
    private List<Book> books = [];
    private List<Store> stores = [];
    private Book? selectedBook;
    private Store? selectedStore;
    private string sourceType = "none";
    private bool isSaving = false;
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load books and stores with caching
            books = (await RecipeService.GetBooksAsync())?.ToList() ?? [];
            stores = (await RecipeService.GetStoresAsync())?.ToList() ?? [];
            
            // Set the initial values for editing
            recipe = new Recipe
            {
                Id = RecipeToEdit.Id,
                Name = RecipeToEdit.Name,
                Rating = RecipeToEdit.Rating,
                Notes = RecipeToEdit.Notes,
                BookId = RecipeToEdit.BookId,
                BookPage = RecipeToEdit.BookPage,
                StoreId = RecipeToEdit.StoreId,
                Url = RecipeToEdit.Url,
                CreationDate = RecipeToEdit.CreationDate
            };
            
            // Determine source type
            if (RecipeToEdit.BookId.HasValue)
            {
                sourceType = "book";
                selectedBook = books.FirstOrDefault(b => b.Id == RecipeToEdit.BookId);
            }
            else if (RecipeToEdit.StoreId.HasValue)
            {
                sourceType = "store";
                selectedStore = stores.FirstOrDefault(s => s.Id == RecipeToEdit.StoreId);
            }
            else if (!string.IsNullOrWhiteSpace(RecipeToEdit.Url))
            {
                sourceType = "url";
            }
            else
            {
                sourceType = "none";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing edit dialog");
            errorMessage = "Erreur lors du chargement des données.";
        }
    }

    private async Task SaveAsync()
    {
        errorMessage = null;
        isSaving = true;
        
        try
        {
            // Validate input
            if (string.IsNullOrWhiteSpace(recipe.Name))
            {
                errorMessage = "Le nom de la recette est requis.";
                isSaving = false;
                return;
            }

            // Update source references based on selection
            if (sourceType == "book")
            {
                if (selectedBook == null)
                {
                    errorMessage = "Veuillez sélectionner un livre.";
                    isSaving = false;
                    return;
                }
                recipe.BookId = selectedBook.Id;
                recipe.StoreId = null;
                recipe.Url = null;
            }
            else if (sourceType == "store")
            {
                if (selectedStore == null)
                {
                    errorMessage = "Veuillez sélectionner un magasin ou restaurant.";
                    isSaving = false;
                    return;
                }
                recipe.StoreId = selectedStore.Id;
                recipe.BookId = null;
                recipe.BookPage = null;
                recipe.Url = null;
            }
            else if (sourceType == "url")
            {
                if (string.IsNullOrWhiteSpace(recipe.Url))
                {
                    errorMessage = "Veuillez saisir l'URL du site web.";
                    isSaving = false;
                    return;
                }
                recipe.BookId = null;
                recipe.StoreId = null;
                recipe.BookPage = null;
            }
            else
            {
                recipe.BookId = null;
                recipe.StoreId = null;
                recipe.BookPage = null;
                recipe.Url = null;
            }
            
            // Use service layer for update
            var result = await RecipeService.UpdateAsync(recipe);
            
            if (result.IsSuccess)
            {
                Snackbar.Add("Recette modifiée avec succès!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(result.Value));
            }
            else
            {
                errorMessage = result.ErrorMessage ?? "Échec lors de la mise à jour de la recette.";
                Snackbar.Add(errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Unexpected error updating recipe");
            errorMessage = $"Une erreur inattendue s'est produite: {ex.Message}";
            Snackbar.Add(errorMessage, Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }
    
    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
