@page "/recipes"
@using Microsoft.Extensions.Logging
@using MudBlazor
@using RecettesIndex.Models
@using RecettesIndex.Services
@using RecettesIndex.Services.Abstractions
@using RecettesIndex.Components
@using Microsoft.JSInterop
@inject AuthService AuthService
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@inject ILogger<Recipes> Logger
@inject IRecipeService RecipeService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject LocalStorageService LocalStorage

<PageTitle>Recettes</PageTitle>

<MudPaper Class="pa-4">
    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <div>
            <MudText Typo="Typo.h5">Recettes</MudText>
            <MudBreadcrumbs Items="breadcrumbs" Class="mt-2" />
        </div>
        
        <!-- View Toggle Button -->
        <MudTooltip Text="@(isCardView ? "Passer en vue liste" : "Passer en vue grille")">
            <MudToggleIconButton @bind-Toggled="isCardView"
                                Icon="@Icons.Material.Filled.ViewList"
                                ToggledIcon="@Icons.Material.Filled.ViewModule"
                                Color="Color.Primary"
                                Size="Size.Large" />
        </MudTooltip>
    </MudStack>
    
    <!-- Quick Filter Buttons -->
    <MudStack Row Wrap="Wrap.Wrap" Spacing="2" Class="mb-3">
        <MudChip T="string" 
                 Color="@(showAllRecipes ? Color.Primary : Color.Default)" 
                 OnClick="ShowAll" 
                 Label="true">
            Toutes (@totalCount)
        </MudChip>
        <MudChip T="string" 
                 Color="@(quickFilterRating == 5 ? Color.Success : Color.Default)" 
                 Style="@(quickFilterRating == 5 ? "background-color: #4CAF50 !important; color: white !important;" : "")"
                 OnClick="() => ApplyQuickFilter(5)" 
                 Label="true" 
                 Icon="@Icons.Material.Filled.LocalPizza">
            5 √âtoiles (@fiveStarCount)
        </MudChip>
        <MudChip T="string" 
                 Color="@(quickFilterRating == 4 ? Color.Info : Color.Default)" 
                 Style="@(quickFilterRating == 4 ? "background-color: #2196F3 !important; color: white !important;" : "")"
                 OnClick="() => ApplyQuickFilter(4)" 
                 Label="true"
                 Icon="@Icons.Material.Filled.LocalPizza">
            4+ √âtoiles (@fourPlusStarCount)
        </MudChip>
        <MudChip T="string" 
                 Color="@(quickFilterUnrated ? Color.Dark : Color.Default)" 
                 Style="@(quickFilterUnrated ? "background-color: #757575 !important; color: white !important;" : "")"
                 OnClick="ShowUnrated" 
                 Label="true"
                 Icon="@Icons.Material.Filled.HelpOutline">
            Non √©valu√©es (@unratedCount)
        </MudChip>
        
        <MudChip T="string" 
                 Color="@(showFavorites ? Color.Error : Color.Default)" 
                 Style="@(showFavorites ? "background-color: #F44336 !important; color: white !important;" : "")"
                 OnClick="ShowFavorites" 
                 Label="true"
                 Icon="@Icons.Material.Filled.Favorite">
            Mes Favoris (@favoritesCount)
        </MudChip>
        
        <!-- New Presets -->
        <MudChip T="string" Color="@(showRecentRecipes ? Color.Info : Color.Default)" 
                 OnClick="ShowRecent" 
                 Label="true"
                 Icon="@Icons.Material.Filled.Schedule">
            Ajout√©es r√©cemment (30j)
        </MudChip>
        <MudChip T="string" Color="Color.Secondary" 
                 OnClick="ShowRandom" 
                 Label="true"
                 Icon="@Icons.Material.Filled.Shuffle">
            Surprise !
        </MudChip>
        
        @if (!string.IsNullOrWhiteSpace(searchTerm) || ratingFilter != null || bookFilter != null || authorFilter != null)
        {
            <MudChip T="string" Color="Color.Error" 
                     OnClick="ClearAllFilters" 
                     Label="true"
                     Icon="@Icons.Material.Filled.Clear">
                R√©initialiser les filtres
            </MudChip>
        }
    </MudStack>
    
    <!-- Collapsible Advanced Filters -->
    <MudExpansionPanels Class="mb-3">
        <MudExpansionPanel Text="Filtres Avanc√©s" 
                          Icon="@Icons.Material.Filled.FilterList">
            <TitleContent>
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.FilterList" Class="mr-2" />
                    <MudText>Filtres Avanc√©s</MudText>
                    @if (HasActiveFilters())
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Class="ml-2">
                            @GetActiveFilterCount()
                        </MudChip>
                    }
                </div>
            </TitleContent>
            <ChildContent>
                <!-- Search and Filter Controls -->
                <MudStack Spacing="3" Class="mt-2">
                    <!-- Search -->
                    <MudTextField T="string" 
                                  Value="@searchTerm" 
                                  ValueChanged="OnSearchChanged" 
                                  Placeholder="Rechercher des recettes..." 
                                  Adornment="Adornment.Start" 
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Clearable="true"
                                  Immediate="false"
                                  DebounceInterval="300"
                                  HelperText="Recherchez par nom de recette"
                                  Variant="Variant.Outlined" />
                    
                    <!-- Filter Row -->
                    <MudStack Row Spacing="2" Wrap="Wrap.Wrap">
                        <MudSelect T="string" 
                                   Value="@ratingFilter" 
                                   ValueChanged="OnRatingChanged" 
                                   Clearable="true" 
                                   Label="√âvaluation" 
                                   Variant="Variant.Outlined"
                                   Style="min-width: 200px;">
                            <MudSelectItem T="string" Value='@("all")'>Toutes</MudSelectItem>
                            <MudSelectItem T="string" Value='@("1")'>üçï 1</MudSelectItem>
                            <MudSelectItem T="string" Value='@("2")'>üçï 2</MudSelectItem>
                            <MudSelectItem T="string" Value='@("3")'>üçï 3</MudSelectItem>
                            <MudSelectItem T="string" Value='@("4")'>üçï 4</MudSelectItem>
                            <MudSelectItem T="string" Value='@("5")'>üçï 5</MudSelectItem>
                        </MudSelect>
                        
                        <MudSelect T="string" 
                                   Value="@bookFilter" 
                                   ValueChanged="OnBookChanged" 
                                   Clearable="true" 
                                   Label="Livre" 
                                   Variant="Variant.Outlined"
                                   Style="min-width: 250px;">
                            <MudSelectItem T="string" Value='@("all")'>Tous (@books.Count)</MudSelectItem>
                            @foreach (var b in books)
                            {
                                var recipeCount = GetRecipeCountForBook(b.Id);
                                <MudSelectItem T="string" Value="@b.Id.ToString()">@b.Name (@recipeCount)</MudSelectItem>
                            }
                        </MudSelect>
                        
                        <MudSelect T="string" 
                                   Value="@authorFilter" 
                                   ValueChanged="OnAuthorChanged" 
                                   Clearable="true" 
                                   Label="Auteur" 
                                   Variant="Variant.Outlined"
                                   Style="min-width: 250px;">
                            <MudSelectItem T="string" Value='@("all")'>Tous (@authors.Count)</MudSelectItem>
                            @foreach (var a in authors)
                            {
                                var recipeCount = GetRecipeCountForAuthor(a.Id);
                                <MudSelectItem T="string" Value="@a.Id.ToString()">@a.FullName (@recipeCount)</MudSelectItem>
                            }
                        </MudSelect>
                    </MudStack>
                    
                    <!-- Filter Actions -->
                    @if (HasActiveFilters())
                    {
                        <MudStack Row Spacing="1" Class="mt-2">
                            <MudButton Variant="Variant.Outlined" 
                                      Color="Color.Error" 
                                      Size="Size.Small"
                                      StartIcon="@Icons.Material.Filled.Clear"
                                      OnClick="ClearAllFilters">
                                Tout effacer
                            </MudButton>
                        </MudStack>
                    }
                </MudStack>
            </ChildContent>
        </MudExpansionPanel>
    </MudExpansionPanels>

    <!-- Active Filters Display -->
    @if (HasActiveFilters())
    {
        <MudPaper Elevation="0" Class="pa-2 mb-2" Style="background-color: #f5f5f5;">
            <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.body2" Style="font-weight: 500;">Filtres actifs:</MudText>
                @if (!string.IsNullOrWhiteSpace(searchTerm))
                {
                    <MudChip T="string" Size="Size.Small" OnClose="() => ClearSearch()">
                        Recherche: @searchTerm
                    </MudChip>
                }
                @if (ratingFilter != null && ratingFilter != "all")
                {
                    <MudChip T="string" Size="Size.Small" OnClose="() => ClearRating()">
                        Note: @ratingFilter üçï
                    </MudChip>
                }
                @if (bookFilter != null && bookFilter != "all")
                {
                    var book = books.FirstOrDefault(b => b.Id.ToString() == bookFilter);
                    if (book != null)
                    {
                        <MudChip T="string" Size="Size.Small" OnClose="() => ClearBook()">
                            Livre: @book.Name
                        </MudChip>
                    }
                }
                @if (authorFilter != null && authorFilter != "all")
                {
                    var author = authors.FirstOrDefault(a => a.Id.ToString() == authorFilter);
                    if (author != null)
                    {
                        <MudChip T="string" Size="Size.Small" OnClose="() => ClearAuthor()">
                            Auteur: @author.FullName
                        </MudChip>
                    }
                }
            </MudStack>
        </MudPaper>
    }

    <!-- Loading State with Skeleton -->
    @if (isLoading)
    {
        @if (isCardView)
        {
            <MudGrid Spacing="3" Class="mt-4">
                @for (int i = 0; i < 8; i++)
                {
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <RecipeCardSkeleton />
                    </MudItem>
                }
            </MudGrid>
        }
        else
        {
            <div class="mt-4">
                @for (int i = 0; i < 5; i++)
                {
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="60px" Class="mb-2" Animation="Animation.Wave" />
                }
            </div>
        }
    }
    else if (currentRecipes.Count == 0)
    {
        <!-- Empty State -->
        <EmptyState Icon="@Icons.Material.Filled.RestaurantMenu"
                    IconColor="Color.Secondary"
                    Title="@GetEmptyStateTitle()"
                    Message="@GetEmptyStateMessage()"
                    ShowAction="@(!HasActiveFilters())"
                    ActionText="Ajouter une recette"
                    ActionIcon="@Icons.Material.Filled.Add"
                    OnActionClick="ShowAddDialog"
                    SecondaryActionText="@(HasActiveFilters() ? "R√©initialiser les filtres" : null)"
                    OnSecondaryActionClick="ClearAllFilters" />
    }
    else
    {
        <!-- Card View -->
        @if (isCardView)
        {
            <MudGrid Spacing="3" Class="mt-4">
                @foreach (var recipe in currentRecipes)
                {
                    var book = books.FirstOrDefault(b => b.Id == recipe.BookId);
                    <MudItem xs="12" sm="6" md="4" lg="3" Style="animation: fadeIn 0.3s ease-out;">
                        <RecipeCard Recipe="@recipe"
                                   Book="@book"
                                   IsAuthenticated="@AuthService.IsAuthenticated"
                                   IsFavorite="@favoriteRecipeIds.Contains(recipe.Id)"
                                   OnView="ViewRecipe"
                                   OnEdit="ShowEditDialog"
                                   OnDelete="DeleteRecipe"
                                   OnPrint="PrintRecipe"
                                   OnToggleFavorite="ToggleFavorite" />
                    </MudItem>
                }
            </MudGrid>
            
            <!-- Pagination for Card View -->
            <div class="d-flex justify-center mt-4">
                <MudPagination Count="@totalPages" 
                              SelectedChanged="OnPageChanged" 
                              Selected="@currentPage"
                              Color="Color.Primary"
                              ShowFirstButton="true"
                              ShowLastButton="true" />
            </div>
        }
        else
        {
            <!-- Table View -->
            <MudTable T="Recipe" ServerData="LoadServerData" Hover="true" Elevation="1" Dense="true" RowsPerPage="20" @ref="table" Class="recipe-table">
                <PagerContent>
                    <MudTablePager InfoFormat="Affichage {first_item}-{last_item} sur {all_items}"
                                   RowsPerPageString="Lignes par page:"
                                   PageSizeOptions="[10, 20, 50]" />
                </PagerContent>
                <HeaderContent>
                    <MudTh><MudTableSortLabel T="Recipe" SortLabel="name">Nom</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel T="Recipe" SortLabel="rating">√âvaluation</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel T="Recipe" SortLabel="created_at">Cr√©√©e le</MudTableSortLabel></MudTh>
                    <MudTh>Notes</MudTh>
                    <MudTh>Livre</MudTh>
                    @if (AuthService.IsAuthenticated)
                    {
                        <MudTh>Actions</MudTh>
                    }
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Nom" Style="@GetRowStyle(context)">
                        <MudLink Href="@($"/recipes/{context.Id}")" Style="cursor:pointer">@context.Name</MudLink>
                    </MudTd>
                    <MudTd DataLabel="√âvaluation" Style="@GetRowStyle(context)">
                        <PizzaRating Value="@context.Rating" />
                    </MudTd>
                    <MudTd DataLabel="Cr√©√©e le" Style="@GetRowStyle(context)">@context.CreationDate.ToShortDateString()</MudTd>
                    <MudTd DataLabel="Notes" Style="@GetRowStyle(context)">
                        @if (!string.IsNullOrWhiteSpace(context.Notes))
                        {
                            var preview = context.Notes.Length > 50 ? context.Notes.Substring(0, 50) + "..." : context.Notes;
                            <MudTooltip Text="@context.Notes">
                                <MudText Typo="Typo.body2">@preview</MudText>
                            </MudTooltip>
                        }
                    </MudTd>
                    <MudTd DataLabel="Livre" Style="@GetRowStyle(context)">
                        @if (context.BookId != null)
                        {
                            var book = books.FirstOrDefault(b => b.Id == context.BookId);
                            if (book != null)
                            {
                                <MudLink Href="@($"/books/{book.Id}")" Style="cursor:pointer">@book.Name</MudLink>
                            }
                        }
                    </MudTd>
                    @if (AuthService.IsAuthenticated)
                    {
                        <MudTd Style="@GetRowStyle(context)">
                            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="() => ShowEditDialog(context)">Modifier</MudButton>
                            <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="() => DeleteRecipe(context)">Supprimer</MudButton>
                        </MudTd>
                    }
                </RowTemplate>
            </MudTable>
        }
    }
    
    @if (AuthService.IsAuthenticated)
    {
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-2" OnClick="ShowAddDialog">Ajouter une recette</MudButton>
    }
</MudPaper>

@code {
    private MudTable<Recipe>? table;
    private List<Book> books = [];
    private List<Author> authors = [];
    private List<BreadcrumbItem> breadcrumbs =>
    [
        new BreadcrumbItem("Accueil", href: ""),
        new BreadcrumbItem("Recettes", href: "/recipes", disabled: true)
    ];
    private string searchTerm = string.Empty;
    private string? ratingFilter;
    private string? bookFilter;
    private string? authorFilter;
    
    // Quick filter state
    private bool showAllRecipes = true;
    private int? quickFilterRating = null;
    private bool quickFilterUnrated = false;
    private bool showRecentRecipes = false;
    private bool showFavorites = false;
    private List<int> favoriteRecipeIds = new();
    
    // Filter counts
    private int totalCount = 0;
    private int fiveStarCount = 0;
    private int fourPlusStarCount = 0;
    private int unratedCount = 0;
    private int favoritesCount = 0;
    private Dictionary<int, int> bookRecipeCounts = new();
    private Dictionary<int, int> authorRecipeCounts = new();
    
    // Memoized active filter count
    private int? _cachedActiveFilterCount = null;
    
    private int GetActiveFilterCount()
    {
        // Return cached value if available
        if (_cachedActiveFilterCount.HasValue)
        {
            return _cachedActiveFilterCount.Value;
        }
        
        // Calculate and cache
        int count = 0;
        if (!string.IsNullOrWhiteSpace(searchTerm)) count++;
        if (ratingFilter != null && ratingFilter != "all") count++;
        if (bookFilter != null && bookFilter != "all") count++;
        if (authorFilter != null && authorFilter != "all") count++;
        
        _cachedActiveFilterCount = count;
        return count;
    }
    
    /// <summary>
    /// Invalidates the cached filter count when filters change.
    /// </summary>
    private void InvalidateFilterCountCache()
    {
        _cachedActiveFilterCount = null;
    }
    
    // Card view state
    private bool _isCardView = false;
    private bool isCardView 
    { 
        get => _isCardView;
        set
        {
            if (_isCardView != value)
            {
                _isCardView = value;
                _ = OnViewModeChanged();
            }
        }
    }
    
    private async Task OnViewModeChanged()
    {
        await SaveViewPreference();
        
        if (isCardView)
        {
            currentPage = 1;
            await LoadCardViewData();
        }
        else
        {
            await Reload();
        }
    }
    
    private bool isLoading = true;
    private List<Recipe> currentRecipes = new();
    private int currentPage = 1;
    private int pageSize = 12;
    private int totalPages = 0;
    private const string ViewModeKey = "recipeViewMode";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            
            // Load view preference from localStorage first
            await LoadViewPreference();
            
            // Load recipes and filter data BEFORE reading query parameters
            await LoadRecipes();
            await LoadFilterCounts();
            
            // Read query parameters from URL
            await ReadQueryParameters();
            
            // Load data based on view mode
            if (isCardView)
            {
                await LoadCardViewData();
            }
            else
            {
                // For table view, set loading to false since table handles its own loading
                isLoading = false;
            }
        }
        catch (Exception)
        {
            // Log error if needed
            isLoading = false;
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        // Read query parameters when URL changes
        await ReadQueryParameters();
    }
    
    private async Task ReadQueryParameters()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        
        // Check for bookId parameter
        var bookIdParam = query["bookId"];
        if (!string.IsNullOrEmpty(bookIdParam) && int.TryParse(bookIdParam, out var bookId))
        {
            bookFilter = bookId.ToString();
            showAllRecipes = false;
            
            // Reload data if already initialized
            if (books.Any())
            {
                if (isCardView)
                    await LoadCardViewData();
                else
                    await Reload();
            }
        }
    }
    
    private async Task LoadViewPreference()
    {
        try
        {
            var viewMode = await JSRuntime.InvokeAsync<string>("localStorage.getItem", ViewModeKey);
            _isCardView = viewMode == "card"; // Set directly to avoid triggering OnViewModeChanged
        }
        catch
        {
            _isCardView = false;
        }
    }
    
    private async Task SaveViewPreference()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", ViewModeKey, isCardView ? "card" : "table");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to save view preference to localStorage");
            // Silently fail if localStorage is not available
        }
    }
    
    private async Task ShowRecent()
    {
        showAllRecipes = false;
        showRecentRecipes = true;
        quickFilterRating = null;
        quickFilterUnrated = false;
        ratingFilter = null;
        bookFilter = null;
        authorFilter = null;
        searchTerm = string.Empty;
        currentPage = 1;
        
        // This will filter recipes from the last 30 days
        // We'll implement this in the search logic
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }
    
    private async Task ShowRandom()
    {
        try
        {
            // First, get the total count without loading all recipes
            var countResult = await RecipeService.SearchAsync(null, null, null, null, 1, 1);
            if (!countResult.IsSuccess || countResult.Value.Total == 0)
            {
                Snackbar.Add("Aucune recette disponible", Severity.Warning);
                return;
            }
            
            // Pick a random index based on total count
            var random = new Random();
            var randomIndex = random.Next(0, countResult.Value.Total);
            var randomPage = (randomIndex / 1) + 1; // Page number for single-item fetch
            
            // Fetch only the specific random recipe
            var result = await RecipeService.SearchAsync(null, null, null, null, randomPage, 1);
            if (result.IsSuccess && result.Value.Items.Any())
            {
                var randomRecipe = result.Value.Items.First();
                
                // Navigate to it
                NavigationManager.NavigateTo($"/recipes/{randomRecipe.Id}");
                Snackbar.Add($"üé≤ Surprise: {randomRecipe.Name}!", Severity.Info);
            }
            else
            {
                Snackbar.Add("Aucune recette disponible", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error selecting random recipe");
            Snackbar.Add("Erreur lors de la s√©lection al√©atoire", Severity.Error);
        }
    }

    private async Task ShowAll()
    {
        showAllRecipes = true;
        showRecentRecipes = false;
        quickFilterRating = null;
        quickFilterUnrated = false;
        ratingFilter = null;
        currentPage = 1;
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ApplyQuickFilter(int rating)
    {
        showAllRecipes = false;
        showRecentRecipes = false;
        quickFilterRating = rating;
        quickFilterUnrated = false;
        ratingFilter = rating >= 4 ? null : rating.ToString();
        currentPage = 1;
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ShowUnrated()
    {
        showAllRecipes = false;
        showRecentRecipes = false;
        quickFilterRating = null;
        quickFilterUnrated = true;
        ratingFilter = null;
        currentPage = 1;
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ShowFavorites()
    {
        // Toggle favorites filter
        if (showFavorites)
        {
            // If already showing favorites, turn it off and show all
            showFavorites = false;
            showAllRecipes = true;
        }
        else
        {
            // Turn on favorites filter
            showAllRecipes = false;
            showRecentRecipes = false;
            quickFilterRating = null;
            quickFilterUnrated = false;
            showFavorites = true;
            ratingFilter = null;
            bookFilter = null;
            authorFilter = null;
            searchTerm = string.Empty;
        }
        
        currentPage = 1;
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ClearAllFilters()
    {
        searchTerm = string.Empty;
        ratingFilter = null;
        bookFilter = null;
        authorFilter = null;
        showAllRecipes = true;
        showRecentRecipes = false;
        quickFilterRating = null;
        quickFilterUnrated = false;
        currentPage = 1;
        showFavorites = false;
        InvalidateFilterCountCache();
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ClearSearch()
    {
        searchTerm = string.Empty;
        currentPage = 1;
        InvalidateFilterCountCache();
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ClearRating()
    {
        ratingFilter = null;
        quickFilterRating = null;
        quickFilterUnrated = false;
        showAllRecipes = true;
        showRecentRecipes = false;
        currentPage = 1;
        InvalidateFilterCountCache();
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }
    
    private async Task LoadCardViewData()
    {
        isLoading = true;
        try
        {
            // Apply filters
            int? rating = GetRatingFilter();
            int? bookId = GetBookIdFilter();
            int? authorId = GetAuthorIdFilter();
            
            var result = await RecipeService.SearchAsync(
                searchTerm,
                rating,
                bookId,
                authorId,
                currentPage,
                pageSize,
                "created_at",
                true
            );
            
            if (result.IsSuccess)
            {
                var items = result.Value.Items.ToList();
                
                // Apply recent filter if active
                if (showRecentRecipes)
                {
                    var thirtyDaysAgo = DateTime.UtcNow.AddDays(-30);
                    items = items.Where(r => r.CreationDate >= thirtyDaysAgo).ToList();
                }
                
                // Apply favorites filter if active
                if (showFavorites)
                {
                    items = items.Where(r => favoriteRecipeIds.Contains(r.Id)).ToList();
                }
                
                currentRecipes = items;
                totalPages = (int)Math.Ceiling(items.Count / (double)pageSize);
            }
            else
            {
                currentRecipes = new();
                totalPages = 0;
            }
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task<TableData<Recipe>> LoadServerData(TableState state, CancellationToken token)
    {
        var page = state.Page + 1;
        var pageSize = state.PageSize;
        
        // Apply quick filters
        int? rating = null;
        if (quickFilterUnrated)
        {
            // We'll handle unrated filter in post-processing
        }
        else if (quickFilterRating.HasValue)
        {
            if (quickFilterRating.Value == 4)
            {
                // For 4+, we'll filter in post-processing
            }
            else
            {
                // For exact rating (5, 3, 2, 1), pass to search
                rating = quickFilterRating.Value;
            }
        }
        else if (ratingFilter != "all" && !string.IsNullOrWhiteSpace(ratingFilter))
        {
            rating = int.TryParse(ratingFilter, out var r) ? r : null;
        }
        
        int? bookId = (bookFilter == "all" || string.IsNullOrWhiteSpace(bookFilter)) ? null : (int.TryParse(bookFilter, out var b) ? b : null);
        int? authorId = (authorFilter == "all" || string.IsNullOrWhiteSpace(authorFilter)) ? null : (int.TryParse(authorFilter, out var a) ? a : null);
        
        var sortLabel = state.SortLabel;
        var sortDescending = state.SortDirection == SortDirection.Descending;
        
        var result = await RecipeService.SearchAsync(searchTerm, rating, bookId, authorId, page, pageSize, sortLabel, sortDescending);
        if (!result.IsSuccess)
            return new TableData<Recipe> { Items = Array.Empty<Recipe>(), TotalItems = 0 };
        
        var items = result.Value.Items;
        var total = result.Value.Total;
        
        // Post-process for special filters
        if (quickFilterUnrated)
        {
            items = items.Where(r => r.Rating == 0 || r.Rating < 1).ToList();
            total = items.Count;
        }
        else if (quickFilterRating == 4)
        {
            // Only filter 4+ stars in post-processing
            items = items.Where(r => r.Rating >= 4).ToList();
            total = items.Count;
        }
        
        // Apply recent filter if active
        if (showRecentRecipes)
        {
            var thirtyDaysAgo = DateTime.UtcNow.AddDays(-30);
            items = items.Where(r => r.CreationDate >= thirtyDaysAgo).ToList();
            total = items.Count;
        }
        
        // Apply favorites filter if active
        if (showFavorites)
        {
            items = items.Where(r => favoriteRecipeIds.Contains(r.Id)).ToList();
            total = items.Count;
        }
        
        return new TableData<Recipe> { Items = items, TotalItems = total };
    }
    
    private async Task LoadRecipes()
    {
        books = (await RecipeService.GetBooksAsync())?.ToList() ?? new();
        authors = (await RecipeService.GetAuthorsAsync())?.ToList() ?? new();
        
        if (!isCardView)
        {
            await Reload();
        }
    }

    private async Task LoadFilterCounts()
    {
        // Load favorites from localStorage
        favoriteRecipeIds = await LocalStorage.GetFavoritesAsync();
        
        // Load all recipes to calculate counts
        var result = await RecipeService.SearchAsync(null, null, null, null, 1, 10000);
        if (result.IsSuccess)
        {
            var allRecipes = result.Value.Items;
            totalCount = allRecipes.Count;
            fiveStarCount = allRecipes.Count(r => r.Rating == 5);
            fourPlusStarCount = allRecipes.Count(r => r.Rating >= 4);
            unratedCount = allRecipes.Count(r => r.Rating == 0 || r.Rating < 1);
            favoritesCount = favoriteRecipeIds.Count;
            
            // Calculate book counts
            bookRecipeCounts = allRecipes
                .Where(r => r.BookId.HasValue)
                .GroupBy(r => r.BookId!.Value)
                .ToDictionary(g => g.Key, g => g.Count());
            
            // Calculate author counts (through books)
            authorRecipeCounts = new Dictionary<int, int>();
            foreach (var author in authors)
            {
                var authorBookIds = books.Where(b => b.Authors.Any(a => a.Id == author.Id)).Select(b => b.Id).ToHashSet();
                var count = allRecipes.Count(r => r.BookId.HasValue && authorBookIds.Contains(r.BookId.Value));
                authorRecipeCounts[author.Id] = count;
            }
        }
    }
    
    private int? GetRatingFilter()
    {
        if (quickFilterUnrated)
            return null; // Handle unrated in post-processing
        if (quickFilterRating.HasValue && quickFilterRating.Value != 4)
            return quickFilterRating.Value;
        if (ratingFilter != "all" && !string.IsNullOrWhiteSpace(ratingFilter))
            return int.TryParse(ratingFilter, out var r) ? r : null;
        return null;
    }
    
    private int? GetBookIdFilter()
    {
        return (bookFilter == "all" || string.IsNullOrWhiteSpace(bookFilter)) 
            ? null 
            : (int.TryParse(bookFilter, out var b) ? b : null);
    }
    
    private int? GetAuthorIdFilter()
    {
        return (authorFilter == "all" || string.IsNullOrWhiteSpace(authorFilter)) 
            ? null 
            : (int.TryParse(authorFilter, out var a) ? a : null);
    }

    private int GetRecipeCountForBook(int bookId) => bookRecipeCounts.GetValueOrDefault(bookId, 0);
    private int GetRecipeCountForAuthor(int authorId) => authorRecipeCounts.GetValueOrDefault(authorId, 0);

    private bool HasActiveFilters()
    {
        return !string.IsNullOrWhiteSpace(searchTerm) 
            || (ratingFilter != null && ratingFilter != "all") 
            || (bookFilter != null && bookFilter != "all") 
            || (authorFilter != null && authorFilter != "all");
    }
    
    private string GetEmptyStateTitle()
    {
        if (HasActiveFilters())
            return "Aucune recette trouv√©e";
        return "Aucune recette pour le moment";
    }
    
    private string GetEmptyStateMessage()
    {
        if (HasActiveFilters())
            return "Essayez de modifier vos filtres ou r√©initialisez-les pour voir toutes les recettes.";
        return "Commencez par ajouter votre premi√®re recette pour construire votre collection personnelle.";
    }

    private async Task ClearBook()
    {
        bookFilter = null;
        currentPage = 1;
        InvalidateFilterCountCache();
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ClearAuthor()
    {
        authorFilter = null;
        currentPage = 1;
        InvalidateFilterCountCache();
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ShowAddDialog()
    {
        var dialog = await DialogService.ShowAsync<AddRecipeDialog>("Ajouter une recette");
        var result = await dialog.Result;
        if (result is not null && !result.Canceled)
        {
            await LoadRecipes();
            await LoadFilterCounts();
            
            if (isCardView)
            {
                await LoadCardViewData();
            }
            
            Snackbar.Add("Recette ajout√©e avec succ√®s!", Severity.Success);
        }
    }

    private async Task ShowEditDialog(Recipe recipeToEdit)
    {
        var parameters = new MudBlazor.DialogParameters { ["RecipeToEdit"] = recipeToEdit };
        var dialog = await DialogService.ShowAsync<EditRecipeDialog>("Modifier la recette", parameters);
        var result = await dialog.Result;
        if (result is not null && !result.Canceled)
        {
            await LoadRecipes();
            await LoadFilterCounts();
            
            if (isCardView)
            {
                await LoadCardViewData();
            }
            
            Snackbar.Add("Recette modifi√©e avec succ√®s!", Severity.Success);
        }
    }

    private async Task DeleteRecipe(Recipe recipeToDelete)
    {
        try
        {
            bool? confirm = await DialogService.ShowMessageBox(
                "Confirmer la suppression",
                $"√ätes-vous s√ªr de vouloir supprimer la recette '{recipeToDelete.Name}' ? Cette action est irr√©versible.",
                yesText: "Supprimer",
                cancelText: "Annuler");

            if (confirm != true)
            {
                return;
            }

            var res = await RecipeService.DeleteAsync(recipeToDelete.Id);
            if (res.IsSuccess)
            {
                Snackbar.Add($"La recette '{recipeToDelete.Name}' a √©t√© supprim√©e avec succ√®s.", Severity.Success);
                
                if (isCardView)
                {
                    await LoadCardViewData();
                }
                else
                {
                    await Reload();
                }
                
                await LoadFilterCounts();
            }
            else
            {
                Snackbar.Add(res.ErrorMessage ?? "Une erreur s'est produite lors de la suppression de la recette.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting recipe");
            Snackbar.Add("Une erreur s'est produite lors de la suppression de la recette. Veuillez r√©essayer.", Severity.Error);
        }
    }

    private async Task Reload()
    {
        if (table is not null)
        {
            await table.ReloadServerData();
        }
    }

    private async Task OnRatingChanged(string? value)
    {
        ratingFilter = value;
        showAllRecipes = false;
        quickFilterRating = null;
        quickFilterUnrated = false;
        currentPage = 1;
        InvalidateFilterCountCache();
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task OnBookChanged(string? value)
    {
        bookFilter = value;
        currentPage = 1;
        InvalidateFilterCountCache();
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task OnAuthorChanged(string? value)
    {
        authorFilter = value;
        currentPage = 1;
        InvalidateFilterCountCache();
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task OnSearchChanged(string value)
    {
        searchTerm = value;
        currentPage = 1;
        InvalidateFilterCountCache();
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }
    
    private async Task OnPageChanged(int page)
    {
        currentPage = page;
        await LoadCardViewData();
        StateHasChanged();
    }
    
    private void ViewRecipe(Recipe recipe)
    {
        NavigationManager.NavigateTo($"/recipes/{recipe.Id}");
    }
    
    private void PrintRecipe(Recipe recipe)
    {
        NavigationManager.NavigateTo($"/recipes/{recipe.Id}/print");
    }
    
    private async Task ToggleFavorite(Recipe recipe)
    {
        await LocalStorage.ToggleFavoriteAsync(recipe.Id);
        
        // Refresh favorites list
        favoriteRecipeIds = await LocalStorage.GetFavoritesAsync();
        favoritesCount = favoriteRecipeIds.Count;
        
        // If showing favorites, reload to update the list
        if (showFavorites)
        {
            if (isCardView)
                await LoadCardViewData();
            else
                await Reload();
        }
        
        StateHasChanged();
        
        var isFavorite = favoriteRecipeIds.Contains(recipe.Id);
        Snackbar.Add(
            isFavorite ? $"'{recipe.Name}' ajout√© aux favoris ‚ù§Ô∏è" : $"'{recipe.Name}' retir√© des favoris",
            isFavorite ? Severity.Success : Severity.Info
        );
    }

    private string GetRowStyle(Recipe recipe)
    {
        // Use centralized color service for consistent rating-based colors
        return RatingColorService.GetRowBackgroundStyle(recipe.Rating);
    }
}
