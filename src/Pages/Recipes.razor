@page "/recipes"
@using Microsoft.Extensions.Logging
@using MudBlazor
@using RecettesIndex.Models
@using RecettesIndex.Services
@using RecettesIndex.Services.Abstractions
@using RecettesIndex.Components
@using Microsoft.JSInterop
@inject AuthService AuthService
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@inject ILogger<Recipes> Logger
@inject IRecipeService RecipeService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject ILocalStorageService LocalStorage
@implements IDisposable

<PageTitle>Recettes</PageTitle>

<MudPaper Class="pa-4">
    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <div>
            <MudText Typo="Typo.h4">Recettes</MudText>
            <MudBreadcrumbs Items="breadcrumbs" Class="mt-2" />
        </div>
        
        <!-- View Toggle Button -->
        <MudTooltip Text="@(isCardView ? "Passer en vue liste" : "Passer en vue grille")">
            <MudToggleIconButton @bind-Toggled="isCardView"
                                Icon="@Icons.Material.Filled.ViewList"
                                ToggledIcon="@Icons.Material.Filled.ViewModule"
                                Color="Color.Primary"
                                Size="Size.Large" />
        </MudTooltip>
    </MudStack>
    
    <!-- Quick Filter Buttons -->
    <RecipeQuickFilters ShowAllRecipes="@Filters.ShowAllRecipes"
                       QuickFilterRating="@Filters.QuickFilterRating"
                       QuickFilterUnrated="@Filters.QuickFilterUnrated"
                       ShowRecentRecipes="@Filters.ShowRecentRecipes"
                       ShowFavorites="@Filters.ShowFavorites"
                       HasActiveFilters="@Filters.HasActiveFilters()"
                       TotalCount="@totalCount"
                       FiveStarCount="@fiveStarCount"
                       FourPlusStarCount="@fourPlusStarCount"
                       UnratedCount="@unratedCount"
                       FavoritesCount="@favoritesCount"
                       OnShowAll="ShowAll"
                       OnApplyQuickFilter="ApplyQuickFilter"
                       OnShowUnrated="ShowUnrated"
                       OnShowFavorites="ShowFavorites"
                       OnShowRecent="ShowRecent"
                       OnShowRandom="ShowRandom"
                       OnClearAllFilters="ClearAllFilters" />
    
    <!-- Collapsible Advanced Filters -->
    <RecipeAdvancedFilters SearchTerm="@Filters.SearchTerm"
                          RatingFilter="@Filters.RatingFilter"
                          BookFilter="@Filters.BookFilter"
                          StoreFilter="@Filters.StoreFilter"
                          AuthorFilter="@Filters.AuthorFilter"
                          ActiveFilterCount="@Filters.GetActiveFilterCount()"
                          Books="@books"
                          Stores="@stores"
                          Authors="@authors"
                          BookRecipeCounts="@bookRecipeCounts"
                          StoreRecipeCounts="@storeRecipeCounts"
                          AuthorRecipeCounts="@authorRecipeCounts"
                          OnSearchChanged="OnSearchChanged"
                          OnRatingChanged="OnRatingChanged"
                          OnBookChanged="OnBookChanged"
                          OnStoreChanged="OnStoreChanged"
                          OnAuthorChanged="OnAuthorChanged"
                          OnClearAllFilters="ClearAllFilters" />

    <!-- Active Filters Display -->
    <RecipeActiveFilters HasActiveFilters="@Filters.HasActiveFilters()"
                        SearchTerm="@Filters.SearchTerm"
                        RatingFilter="@Filters.RatingFilter"
                        BookFilter="@Filters.BookFilter"
                        StoreFilter="@Filters.StoreFilter"
                        AuthorFilter="@Filters.AuthorFilter"
                        Books="@books"
                        Stores="@stores"
                        Authors="@authors"
                        OnClearSearch="ClearSearch"
                        OnClearRating="ClearRating"
                        OnClearBook="ClearBook"
                        OnClearStore="ClearStore"
                        OnClearAuthor="ClearAuthor"
                        OnClearAll="ClearAllFilters" />

    <!-- Loading State -->
    @if (isLoading)
    {
        <RecipeLoadingState IsCardView="@isCardView" SkeletonCount="8" />
    }
    else if (errorMessage != null)
    {
        <MudAlert Severity="Severity.Error">@errorMessage</MudAlert>
    }
    else if (isCardView && currentRecipes.Count == 0)
    {
        <!-- Empty State -->
        <EmptyState Icon="@Icons.Material.Filled.RestaurantMenu"
                    IconColor="Color.Secondary"
                    Title="@GetEmptyStateTitle()"
                    Message="@GetEmptyStateMessage()"
                    ShowAction="@(!Filters.HasActiveFilters())"
                    ActionText="Ajouter une recette"
                    ActionIcon="@Icons.Material.Filled.Add"
                    OnActionClick="ShowAddDialog"
                    SecondaryActionText="@(Filters.HasActiveFilters() ? "R√©initialiser les filtres" : null)"
                    OnSecondaryActionClick="ClearAllFilters" />
    }
    else
    {
        <!-- Card View -->
        @if (isCardView)
        {
            <RecipeGridView Recipes="@currentRecipes"
                           Books="@books"
                           Stores="@stores"
                           FavoriteRecipeIds="@favoriteRecipeIds"
                           IsAuthenticated="@AuthService.IsAuthenticated"
                           CurrentPage="@currentPage"
                           TotalPages="@totalPages"
                           TotalCount="@filteredTotal"
                           OnViewRecipe="ViewRecipe"
                           OnEditRecipe="ShowEditDialog"
                           OnDeleteRecipe="DeleteRecipe"
                           OnPrintRecipe="PrintRecipe"
                           OnToggleFavorite="ToggleFavorite"
                           OnPageChanged="OnPageChanged" />
        }
        else
        {
            <!-- Table View -->
            <RecipeTableView Books="@books"
                            Stores="@stores"
                            IsAuthenticated="@AuthService.IsAuthenticated"
                            LoadServerData="LoadServerData"
                            OnEditRecipe="ShowEditDialog"
                            OnDeleteRecipe="DeleteRecipe"
                            @ref="tableViewRef" />
        }
    }
    
    @if (AuthService.IsAuthenticated)
    {
        <MudFab Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                OnClick="ShowAddDialog" Label="Ajouter"
                Style="position: fixed; bottom: 24px; right: 24px; z-index: 100;" />
    }
</MudPaper>

@code {
    private RecipeTableView? tableViewRef;
    private List<Book> books = [];
    private List<Author> authors = [];
    private List<Store> stores = [];
    private List<BreadcrumbItem> breadcrumbs =>
    [
        new BreadcrumbItem("Accueil", href: ""),
        new BreadcrumbItem("Recettes", href: "/recipes", disabled: true)
    ];
    
    // All filter-related state is encapsulated in RecipeFilterState
    private RecipeFilterState Filters { get; } = new();

    private List<int> favoriteRecipeIds = new();

    // Filter counts
    private int totalCount = 0;
    private int fiveStarCount = 0;
    private int fourPlusStarCount = 0;
    private int unratedCount = 0;
    private int favoritesCount = 0;
    private Dictionary<int, int> bookRecipeCounts = new();
    private Dictionary<int, int> storeRecipeCounts = new();
    private Dictionary<int, int> authorRecipeCounts = new();
    
    // View state
    private bool _isCardView = false;
    private bool isCardView 
    { 
        get => _isCardView;
        set
        {
            if (_isCardView != value)
            {
                _isCardView = value;
                _ = OnViewModeChanged();
            }
        }
    }
    
    private bool isLoading = true;
    private List<Recipe> currentRecipes = new();
    private int currentPage = 1;
    private int pageSize = PaginationConstants.RecipesDefaultPageSize;
    private int totalPages = 0;
    private int filteredTotal = 0;
    private const string ViewModeKey = "recipeViewMode";
    private string? errorMessage;

    protected override void OnInitialized()
    {
        AuthService.AuthStateChanged += OnAuthStateChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadViewPreference();
            isLoading = true;
            await LoadRecipes();
            await LoadFilterCounts();
            await ReadQueryParameters();
            
            if (isCardView)
            {
                await LoadCardViewData();
            }
            else
            {
                isLoading = false;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing Recipes page");
            isLoading = false;
            StateHasChanged();
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        await ReadQueryParameters();
    }
    
    #region Initialization Methods
    
    private async Task LoadViewPreference()
    {
        try
        {
            var viewMode = await JSRuntime.InvokeAsync<string>("localStorage.getItem", ViewModeKey);
            _isCardView = viewMode == "card";
        }
        catch
        {
            _isCardView = false;
        }
    }
    
    private async Task SaveViewPreference()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", ViewModeKey, isCardView ? "card" : "table");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to save view preference to localStorage");
        }
    }
    
    private async Task ReadQueryParameters()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        
        var bookIdParam = query["bookId"];
        if (!string.IsNullOrEmpty(bookIdParam) && int.TryParse(bookIdParam, out var bookId))
        {
            Filters.BookFilter = bookId.ToString();
            Filters.ShowAllRecipes = false;
            
            if (books.Any())
            {
                if (isCardView)
                    await LoadCardViewData();
                else
                    await Reload();
            }
        }
    }
    
    private async Task LoadRecipes()
    {
        books = (await RecipeService.GetBooksAsync())?.ToList() ?? new();
        authors = (await RecipeService.GetAuthorsAsync())?.ToList() ?? new();
        stores = (await RecipeService.GetStoresAsync())?.ToList() ?? new();
    }

    private async Task LoadFilterCounts()
    {
        favoriteRecipeIds = await LocalStorage.GetFavoritesAsync();

        var allRecipes = await LoadAllRecipesForCounts();
        if (allRecipes.Count > 0)
        {
            totalCount = allRecipes.Count;
            fiveStarCount = allRecipes.Count(r => r.Rating == 5);
            fourPlusStarCount = allRecipes.Count(r => r.Rating >= 4);
            unratedCount = allRecipes.Count(r => r.Rating == 0 || r.Rating < 1);
            favoritesCount = favoriteRecipeIds.Count;
            
            bookRecipeCounts = allRecipes
                .Where(r => r.BookId.HasValue)
                .GroupBy(r => r.BookId!.Value)
                .ToDictionary(g => g.Key, g => g.Count());
            
            storeRecipeCounts = allRecipes
                .Where(r => r.StoreId.HasValue)
                .GroupBy(r => r.StoreId!.Value)
                .ToDictionary(g => g.Key, g => g.Count());
            
            authorRecipeCounts = new Dictionary<int, int>();
            foreach (var author in authors)
            {
                var authorBookIds = books.Where(b => b.Authors.Any(a => a.Id == author.Id)).Select(b => b.Id).ToHashSet();
                var count = allRecipes.Count(r => r.BookId.HasValue && authorBookIds.Contains(r.BookId.Value));
                authorRecipeCounts[author.Id] = count;
            }
        }
        else
        {
            totalCount = 0;
            fiveStarCount = 0;
            fourPlusStarCount = 0;
            unratedCount = 0;
            bookRecipeCounts = new Dictionary<int, int>();
            storeRecipeCounts = new Dictionary<int, int>();
            authorRecipeCounts = new Dictionary<int, int>();
        }
    }

    private async Task<List<Recipe>> LoadAllRecipesForCounts()
    {
        const int pageSizeForCounts = PaginationConstants.CountFetchPageSize;
        var page = 1;
        var allRecipes = new List<Recipe>();

        while (true)
        {
            var result = await RecipeService.SearchAsync(null, null, null, null, null, page, pageSizeForCounts, "created_at", true);
            if (!result.IsSuccess)
            {
                Logger.LogWarning("Failed to load recipe counts page {Page}: {Error}", page, result.ErrorMessage);
                break;
            }

            var items = result.Value.Items.ToList();
            if (items.Count == 0)
            {
                break;
            }

            allRecipes.AddRange(items);

            if (allRecipes.Count >= result.Value.Total)
            {
                break;
            }

            page++;
        }

        return allRecipes;
    }
    
    #endregion
    
    #region Data Loading Methods
    
    private async Task OnViewModeChanged()
    {
        await SaveViewPreference();
        
        if (isCardView)
        {
            currentPage = 1;
            await LoadCardViewData();
        }
        else
        {
            await Reload();
        }
    }
    
    private async Task LoadCardViewData()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            int? rating = Filters.GetRatingFilter();
            int? bookId = Filters.GetBookIdFilter();
            int? storeId = Filters.GetStoreIdFilter();
            int? authorId = Filters.GetAuthorIdFilter();

            var result = await RecipeService.SearchAsync(
                Filters.SearchTerm, rating, bookId, storeId, authorId, currentPage, pageSize, "created_at", true);

            if (result.IsSuccess)
            {
                var items = result.Value.Items.ToList();
                var total = result.Value.Total;

                if (Filters.ShowRecentRecipes)
                {
                    var thirtyDaysAgo = DateTime.UtcNow.AddDays(-UIConstants.RecentRecipeDaysThreshold);
                    items = items.Where(r => r.CreationDate >= thirtyDaysAgo).ToList();
                    total = items.Count;
                }

                if (Filters.ShowFavorites)
                {
                    items = items.Where(r => favoriteRecipeIds.Contains(r.Id)).ToList();
                    total = items.Count;
                }
                
                currentRecipes = items;
                filteredTotal = total;
                totalPages = (int)Math.Ceiling(total / (double)pageSize);
            }
            else
            {
                errorMessage = result.ErrorMessage ?? "Failed to load recipes";
                currentRecipes = [];
                filteredTotal = 0;
                totalPages = 0;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading card view data");
            errorMessage = "An error occurred while loading recipes";
            currentRecipes = [];
            totalPages = 0;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task<TableData<Recipe>> LoadServerData(TableState state, CancellationToken token)
    {
        var page = state.Page + 1;
        var pageSize = state.PageSize;
        
        int? rating = null;
        if (Filters.QuickFilterUnrated)
        {
            // Handle unrated in post-processing
        }
        else if (Filters.QuickFilterRating.HasValue)
        {
            if (Filters.QuickFilterRating.Value == 4)
            {
                // Handle 4+ in post-processing
            }
            else
            {
                rating = Filters.QuickFilterRating.Value;
            }
        }
        else if (Filters.RatingFilter != "all" && !string.IsNullOrWhiteSpace(Filters.RatingFilter))
        {
            rating = int.TryParse(Filters.RatingFilter, out var r) ? r : null;
        }

        int? bookId = Filters.GetBookIdFilter();
        int? storeId = Filters.GetStoreIdFilter();
        int? authorId = Filters.GetAuthorIdFilter();

        var sortLabel = state.SortLabel;
        var sortDescending = state.SortDirection == SortDirection.Descending;

        var result = await RecipeService.SearchAsync(Filters.SearchTerm, rating, bookId, storeId, authorId, page, pageSize, sortLabel, sortDescending, token);
        if (!result.IsSuccess)
        {
            return new TableData<Recipe> { Items = Array.Empty<Recipe>(), TotalItems = 0 };
        }

        var items = result.Value.Items;
        var total = result.Value.Total;

        if (Filters.QuickFilterUnrated)
        {
            items = items.Where(r => r.Rating == 0 || r.Rating < 1).ToList();
            total = items.Count;
        }
        else if (Filters.QuickFilterRating == 4)
        {
            items = items.Where(r => r.Rating >= 4).ToList();
            total = items.Count;
        }

        if (Filters.ShowRecentRecipes)
        {
            var thirtyDaysAgo = DateTime.UtcNow.AddDays(-UIConstants.RecentRecipeDaysThreshold);
            items = items.Where(r => r.CreationDate >= thirtyDaysAgo).ToList();
            total = items.Count;
        }

        if (Filters.ShowFavorites)
        {
            items = items.Where(r => favoriteRecipeIds.Contains(r.Id)).ToList();
            total = items.Count;
        }
        
        return new TableData<Recipe> { Items = items, TotalItems = total };
    }
    
    private async Task Reload()
    {
        if (tableViewRef is not null)
        {
            await tableViewRef.ReloadServerData();
        }
    }
    
    #endregion
    
    // Filter helpers are now in RecipeFilterState (Filters property)
    
    #region Quick Filter Event Handlers
    
    private async Task ShowAll()
    {
        Filters.ShowAllRecipes = true;
        Filters.ShowRecentRecipes = false;
        Filters.QuickFilterRating = null;
        Filters.QuickFilterUnrated = false;
        Filters.RatingFilter = null;
        currentPage = 1;

        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ApplyQuickFilter(int rating)
    {
        Filters.ShowAllRecipes = false;
        Filters.ShowRecentRecipes = false;
        Filters.QuickFilterRating = rating;
        Filters.QuickFilterUnrated = false;
        Filters.RatingFilter = rating >= 4 ? null : rating.ToString();
        currentPage = 1;

        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ShowUnrated()
    {
        Filters.ShowAllRecipes = false;
        Filters.ShowRecentRecipes = false;
        Filters.QuickFilterRating = null;
        Filters.QuickFilterUnrated = true;
        Filters.RatingFilter = null;
        currentPage = 1;

        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ShowFavorites()
    {
        if (Filters.ShowFavorites)
        {
            Filters.ShowFavorites = false;
            Filters.ShowAllRecipes = true;
        }
        else
        {
            Filters.ShowAllRecipes = false;
            Filters.ShowRecentRecipes = false;
            Filters.QuickFilterRating = null;
            Filters.QuickFilterUnrated = false;
            Filters.ShowFavorites = true;
            Filters.RatingFilter = null;
            Filters.BookFilter = null;
            Filters.AuthorFilter = null;
            Filters.SearchTerm = string.Empty;
        }

        currentPage = 1;

        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ShowRecent()
    {
        Filters.ShowAllRecipes = false;
        Filters.ShowRecentRecipes = true;
        Filters.QuickFilterRating = null;
        Filters.QuickFilterUnrated = false;
        Filters.RatingFilter = null;
        Filters.BookFilter = null;
        Filters.AuthorFilter = null;
        Filters.SearchTerm = string.Empty;
        currentPage = 1;

        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }
    
    private async Task ShowRandom()
    {
        try
        {
            var countResult = await RecipeService.SearchAsync(null, null, null, null, null, 1, 1);
            if (!countResult.IsSuccess || countResult.Value.Total == 0)
            {
                Snackbar.Add("Aucune recette disponible", Severity.Warning);
                return;
            }
            
            var random = new Random();
            var randomIndex = random.Next(0, countResult.Value.Total);
            var randomPage = randomIndex + 1;
            
            var result = await RecipeService.SearchAsync(null, null, null, null, null, randomPage, 1);
            if (result.IsSuccess && result.Value.Items.Any())
            {
                var randomRecipe = result.Value.Items.First();
                NavigationManager.NavigateTo($"/recipes/{randomRecipe.Id}");
                Snackbar.Add($"üé≤ Surprise: {randomRecipe.Name}!", Severity.Info);
            }
            else
            {
                Snackbar.Add("Aucune recette disponible", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error selecting random recipe");
            Snackbar.Add("Erreur lors de la s√©lection al√©atoire", Severity.Error);
        }
    }

    private async Task ClearAllFilters()
    {
        Filters.Reset();
        currentPage = 1;

        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }
    
    #endregion
    
    #region Clear Individual Filter Methods
    
    private async Task ClearSearch()
    {
        Filters.SearchTerm = string.Empty;
        currentPage = 1;
        Filters.InvalidateFilterCountCache();

        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ClearRating()
    {
        Filters.RatingFilter = null;
        Filters.QuickFilterRating = null;
        Filters.QuickFilterUnrated = false;
        Filters.ShowAllRecipes = true;
        Filters.ShowRecentRecipes = false;
        currentPage = 1;
        Filters.InvalidateFilterCountCache();

        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ClearBook()
    {
        Filters.BookFilter = null;
        currentPage = 1;
        Filters.InvalidateFilterCountCache();

        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ClearStore()
    {
        Filters.StoreFilter = null;
        currentPage = 1;
        Filters.InvalidateFilterCountCache();

        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ClearAuthor()
    {
        Filters.AuthorFilter = null;
        currentPage = 1;
        Filters.InvalidateFilterCountCache();

        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }
    
    #endregion
    
    #region Filter Changed Event Handlers
    
    private async Task OnRatingChanged(string? value)
    {
        Filters.RatingFilter = value;
        Filters.ShowAllRecipes = false;
        Filters.QuickFilterRating = null;
        Filters.QuickFilterUnrated = false;
        currentPage = 1;
        Filters.InvalidateFilterCountCache();

        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task OnBookChanged(string? value)
    {
        Filters.BookFilter = value;
        currentPage = 1;
        Filters.InvalidateFilterCountCache();

        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task OnStoreChanged(string? value)
    {
        Filters.StoreFilter = value;
        currentPage = 1;
        Filters.InvalidateFilterCountCache();

        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task OnAuthorChanged(string? value)
    {
        Filters.AuthorFilter = value;
        currentPage = 1;
        Filters.InvalidateFilterCountCache();

        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task OnSearchChanged(string value)
    {
        Filters.SearchTerm = value;
        currentPage = 1;
        Filters.InvalidateFilterCountCache();

        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }
    
    private async Task OnPageChanged(int page)
    {
        currentPage = page;
        await LoadCardViewData();
        StateHasChanged();
    }
    
    #endregion
    
    #region Recipe Action Methods
    
    private void ViewRecipe(Recipe recipe)
    {
        NavigationManager.NavigateTo($"/recipes/{recipe.Id}");
    }
    
    private void PrintRecipe(Recipe recipe)
    {
        NavigationManager.NavigateTo($"/recipes/{recipe.Id}/print");
    }
    
    private async Task ToggleFavorite(Recipe recipe)
    {
        await LocalStorage.ToggleFavoriteAsync(recipe.Id);
        
        favoriteRecipeIds = await LocalStorage.GetFavoritesAsync();
        favoritesCount = favoriteRecipeIds.Count;
        
        if (Filters.ShowFavorites)
        {
            if (isCardView)
                await LoadCardViewData();
            else
                await Reload();
        }
        
        StateHasChanged();
        
        var isFavorite = favoriteRecipeIds.Contains(recipe.Id);
        Snackbar.Add(
            isFavorite ? $"'{recipe.Name}' ajout√© aux favoris ‚ù§Ô∏è" : $"'{recipe.Name}' retir√© des favoris",
            isFavorite ? Severity.Success : Severity.Info
        );
    }

    private async Task ShowAddDialog()
    {
        var dialog = await DialogService.ShowAsync<AddRecipeDialog>("Ajouter une recette");
        var result = await dialog.Result;
        if (result is not null && !result.Canceled)
        {
            await LoadRecipes();
            await LoadFilterCounts();
            
            if (isCardView)
            {
                await LoadCardViewData();
            }
            
            Snackbar.Add("Recette ajout√©e avec succ√®s!", Severity.Success);
        }
    }

    private async Task ShowEditDialog(Recipe recipeToEdit)
    {
        var parameters = new MudBlazor.DialogParameters { ["RecipeToEdit"] = recipeToEdit };
        var dialog = await DialogService.ShowAsync<EditRecipeDialog>("Modifier la recette", parameters);
        var result = await dialog.Result;
        if (result is not null && !result.Canceled)
        {
            await LoadRecipes();
            await LoadFilterCounts();
            
            if (isCardView)
            {
                await LoadCardViewData();
            }
            
            Snackbar.Add("Recette modifi√©e avec succ√®s!", Severity.Success);
        }
    }

    private async Task DeleteRecipe(Recipe recipeToDelete)
    {
        try
        {
            bool? confirm = await DialogService.ShowMessageBox(
                "Confirmer la suppression",
                $"√ätes-vous s√ªr de vouloir supprimer la recette '{recipeToDelete.Name}' ? Cette action est irr√©versible.",
                yesText: "Supprimer",
                cancelText: "Annuler");

            if (confirm != true)
            {
                return;
            }

            var res = await RecipeService.DeleteAsync(recipeToDelete.Id);
            if (res.IsSuccess)
            {
                Snackbar.Add($"La recette '{recipeToDelete.Name}' a √©t√© supprim√©e avec succ√®s.", Severity.Success);
                
                if (isCardView)
                {
                    await LoadCardViewData();
                }
                else
                {
                    await Reload();
                }
                
                await LoadFilterCounts();
            }
            else
            {
                Snackbar.Add(res.ErrorMessage ?? "Une erreur s'est produite lors de la suppression de la recette.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting recipe");
            Snackbar.Add("Une erreur s'est produite lors de la suppression de la recette. Veuillez r√©essayer.", Severity.Error);
        }
    }
    
    #endregion
    
    #region Helper Methods
    
    private string GetEmptyStateTitle() =>
        Filters.HasActiveFilters() ? "Aucune recette trouv√©e" : "Aucune recette pour le moment";

    private string GetEmptyStateMessage() =>
        Filters.HasActiveFilters()
            ? "Essayez de modifier vos filtres ou r√©initialisez-les pour voir toutes les recettes."
            : "Commencez par ajouter votre premi√®re recette pour construire votre collection personnelle.";

    private void OnAuthStateChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AuthService.AuthStateChanged -= OnAuthStateChanged;
    }
    
    #endregion
}
