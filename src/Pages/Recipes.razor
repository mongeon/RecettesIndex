@page "/recipes"
@using MudBlazor
@using RecettesIndex.Models
@using RecettesIndex.Services
@using RecettesIndex.Services.Abstractions
@using RecettesIndex.Components
@using Microsoft.JSInterop
@inject AuthService AuthService
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@inject IRecipeService RecipeService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Recettes</PageTitle>

<MudPaper Class="pa-4">
    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <div>
            <MudText Typo="Typo.h5">Recettes</MudText>
            <MudBreadcrumbs Items="breadcrumbs" Class="mt-2" />
        </div>
        
        <!-- View Toggle Button -->
        <MudToggleIconButton @bind-Toggled="isCardView"
                            Icon="@Icons.Material.Filled.ViewList"
                            ToggledIcon="@Icons.Material.Filled.ViewModule"
                            Color="Color.Primary"
                            Title="@(isCardView ? "Vue liste" : "Vue grille")"
                            ToggledTitle="@(isCardView ? "Vue liste" : "Vue grille")"
                            Size="Size.Large" />
    </MudStack>
    
    <!-- Quick Filter Buttons -->
    <MudStack Row Wrap="Wrap.Wrap" Spacing="2" Class="mb-3">
        <MudChip T="string" Color="@(showAllRecipes ? Color.Primary : Color.Default)" 
                 OnClick="ShowAll" 
                 Label="true">
            Toutes (@totalCount)
        </MudChip>
        <MudChip T="string" Color="@(quickFilterRating == 5 ? Color.Success : Color.Default)" 
                 OnClick="() => ApplyQuickFilter(5)" 
                 Label="true" 
                 Icon="@Icons.Material.Filled.LocalPizza">
            5 √âtoiles (@fiveStarCount)
        </MudChip>
        <MudChip T="string" Color="@(quickFilterRating == 4 ? Color.Info : Color.Default)" 
                 OnClick="() => ApplyQuickFilter(4)" 
                 Label="true"
                 Icon="@Icons.Material.Filled.LocalPizza">
            4+ √âtoiles (@fourPlusStarCount)
        </MudChip>
        <MudChip T="string" Color="@(quickFilterUnrated ? Color.Dark : Color.Default)" 
                 OnClick="ShowUnrated" 
                 Label="true"
                 Icon="@Icons.Material.Filled.HelpOutline">
            Non √©valu√©es (@unratedCount)
        </MudChip>
        @if (!string.IsNullOrWhiteSpace(searchTerm) || ratingFilter != null || bookFilter != null || authorFilter != null)
        {
            <MudChip T="string" Color="Color.Error" 
                     OnClick="ClearAllFilters" 
                     Label="true"
                     Icon="@Icons.Material.Filled.Clear">
                R√©initialiser les filtres
            </MudChip>
        }
    </MudStack>
    
    <!-- Advanced Search and Filters -->
    <MudStack Row AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
        <MudTextField T="string" 
                      Value="@searchTerm" 
                      ValueChanged="OnSearchChanged" 
                      Placeholder="Rechercher des recettes..." 
                      Adornment="Adornment.Start" 
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Clearable="true"
                      Immediate="false"
                      DebounceInterval="300" />
        <MudSelect T="string" 
                   Value="@ratingFilter" 
                   ValueChanged="OnRatingChanged" 
                   Clearable="true" 
                   Dense="true" 
                   Label="√âvaluation" 
                   Class="min-w-200">
            <MudSelectItem T="string" Value='@("all")'>Toutes</MudSelectItem>
            <MudSelectItem T="string" Value='@("1")'>üçï 1</MudSelectItem>
            <MudSelectItem T="string" Value='@("2")'>üçï 2</MudSelectItem>
            <MudSelectItem T="string" Value='@("3")'>üçï 3</MudSelectItem>
            <MudSelectItem T="string" Value='@("4")'>üçï 4</MudSelectItem>
            <MudSelectItem T="string" Value='@("5")'>üçï 5</MudSelectItem>
        </MudSelect>
        <MudSelect T="string" 
                   Value="@bookFilter" 
                   ValueChanged="OnBookChanged" 
                   Clearable="true" 
                   Dense="true" 
                   Label="Livre" 
                   Class="min-w-200">
            <MudSelectItem T="string" Value='@("all")'>Tous (@books.Count)</MudSelectItem>
            @foreach (var b in books)
            {
                var recipeCount = GetRecipeCountForBook(b.Id);
                <MudSelectItem T="string" Value="@b.Id.ToString()">@b.Name (@recipeCount)</MudSelectItem>
            }
        </MudSelect>
        <MudSelect T="string" 
                   Value="@authorFilter" 
                   ValueChanged="OnAuthorChanged" 
                   Clearable="true" 
                   Dense="true" 
                   Label="Auteur" 
                   Class="min-w-200">
            <MudSelectItem T="string" Value='@("all")'>Tous (@authors.Count)</MudSelectItem>
            @foreach (var a in authors)
            {
                var recipeCount = GetRecipeCountForAuthor(a.Id);
                <MudSelectItem T="string" Value="@a.Id.ToString()">@a.FullName (@recipeCount)</MudSelectItem>
            }
        </MudSelect>
    </MudStack>

    <!-- Active Filters Display -->
    @if (HasActiveFilters())
    {
        <MudPaper Elevation="0" Class="pa-2 mb-2" Style="background-color: #f5f5f5;">
            <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.body2" Style="font-weight: 500;">Filtres actifs:</MudText>
                @if (!string.IsNullOrWhiteSpace(searchTerm))
                {
                    <MudChip T="string" Size="Size.Small" OnClose="() => ClearSearch()">
                        Recherche: @searchTerm
                    </MudChip>
                }
                @if (ratingFilter != null && ratingFilter != "all")
                {
                    <MudChip T="string" Size="Size.Small" OnClose="() => ClearRating()">
                        Note: @ratingFilter ‚≠ê
                    </MudChip>
                }
                @if (bookFilter != null && bookFilter != "all")
                {
                    var book = books.FirstOrDefault(b => b.Id.ToString() == bookFilter);
                    if (book != null)
                    {
                        <MudChip T="string" Size="Size.Small" OnClose="() => ClearBook()">
                            Livre: @book.Name
                        </MudChip>
                    }
                }
                @if (authorFilter != null && authorFilter != "all")
                {
                    var author = authors.FirstOrDefault(a => a.Id.ToString() == authorFilter);
                    if (author != null)
                    {
                        <MudChip T="string" Size="Size.Small" OnClose="() => ClearAuthor()">
                            Auteur: @author.FullName
                        </MudChip>
                    }
                }
            </MudStack>
        </MudPaper>
    }

    <!-- Loading State with Skeleton -->
    @if (isLoading)
    {
        @if (isCardView)
        {
            <MudGrid Spacing="3" Class="mt-4">
                @for (int i = 0; i < 8; i++)
                {
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <RecipeCardSkeleton />
                    </MudItem>
                }
            </MudGrid>
        }
        else
        {
            <div class="mt-4">
                @for (int i = 0; i < 5; i++)
                {
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="60px" Class="mb-2" Animation="Animation.Wave" />
                }
            </div>
        }
    }
    else if (currentRecipes.Count == 0)
    {
        <!-- Empty State -->
        <EmptyState Icon="@Icons.Material.Filled.RestaurantMenu"
                    IconColor="Color.Secondary"
                    Title="@GetEmptyStateTitle()"
                    Message="@GetEmptyStateMessage()"
                    ShowAction="@(!HasActiveFilters())"
                    ActionText="Ajouter une recette"
                    ActionIcon="@Icons.Material.Filled.Add"
                    OnActionClick="ShowAddDialog"
                    SecondaryActionText="@(HasActiveFilters() ? "R√©initialiser les filtres" : null)"
                    OnSecondaryActionClick="ClearAllFilters" />
    }
    else
    {
        <!-- Card View -->
        @if (isCardView)
        {
            <MudGrid Spacing="3" Class="mt-4">
                @foreach (var recipe in currentRecipes)
                {
                    var book = books.FirstOrDefault(b => b.Id == recipe.BookId);
                    <MudItem xs="12" sm="6" md="4" lg="3" Style="animation: fadeIn 0.3s ease-out;">
                        <RecipeCard Recipe="@recipe"
                                   Book="@book"
                                   IsAuthenticated="@AuthService.IsAuthenticated"
                                   OnView="ViewRecipe"
                                   OnEdit="ShowEditDialog"
                                   OnDelete="DeleteRecipe"
                                   OnPrint="PrintRecipe" />
                    </MudItem>
                }
            </MudGrid>
            
            <!-- Pagination for Card View -->
            <div class="d-flex justify-center mt-4">
                <MudPagination Count="@totalPages" 
                              SelectedChanged="OnPageChanged" 
                              Selected="@currentPage"
                              Color="Color.Primary"
                              ShowFirstButton="true"
                              ShowLastButton="true" />
            </div>
        }
        else
        {
            <!-- Table View -->
            <MudTable T="Recipe" ServerData="LoadServerData" Hover="true" Elevation="1" Dense="true" RowsPerPage="20" @ref="table" Class="recipe-table">
                <PagerContent>
                    <MudTablePager InfoFormat="Affichage {first_item}-{last_item} sur {all_items}"
                                   RowsPerPageString="Lignes par page:"
                                   PageSizeOptions="[10, 20, 50]" />
                </PagerContent>
                <HeaderContent>
                    <MudTh><MudTableSortLabel T="Recipe" SortLabel="name">Nom</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel T="Recipe" SortLabel="rating">√âvaluation</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel T="Recipe" SortLabel="created_at">Cr√©√©e le</MudTableSortLabel></MudTh>
                    <MudTh>Notes</MudTh>
                    <MudTh>Livre</MudTh>
                    @if (AuthService.IsAuthenticated)
                    {
                        <MudTh>Actions</MudTh>
                    }
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Nom" Style="@GetRowStyle(context)">
                        <MudLink Href="@($"/recipes/{context.Id}")" Style="cursor:pointer">@context.Name</MudLink>
                    </MudTd>
                    <MudTd DataLabel="√âvaluation" Style="@GetRowStyle(context)">
                        <PizzaRating Value="@context.Rating" />
                    </MudTd>
                    <MudTd DataLabel="Cr√©√©e le" Style="@GetRowStyle(context)">@context.CreationDate.ToShortDateString()</MudTd>
                    <MudTd DataLabel="Notes" Style="@GetRowStyle(context)">
                        @if (!string.IsNullOrWhiteSpace(context.Notes))
                        {
                            var preview = context.Notes.Length > 50 ? context.Notes.Substring(0, 50) + "..." : context.Notes;
                            <MudTooltip Text="@context.Notes">
                                <MudText Typo="Typo.body2">@preview</MudText>
                            </MudTooltip>
                        }
                    </MudTd>
                    <MudTd DataLabel="Livre" Style="@GetRowStyle(context)">
                        @if (context.BookId != null)
                        {
                            var book = books.FirstOrDefault(b => b.Id == context.BookId);
                            if (book != null)
                            {
                                <MudLink Href="@($"/books/{book.Id}")" Style="cursor:pointer">@book.Name</MudLink>
                            }
                        }
                    </MudTd>
                    @if (AuthService.IsAuthenticated)
                    {
                        <MudTd Style="@GetRowStyle(context)">
                            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="() => ShowEditDialog(context)">Modifier</MudButton>
                            <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="() => DeleteRecipe(context)">Supprimer</MudButton>
                        </MudTd>
                    }
                </RowTemplate>
            </MudTable>
        }
    }
    
    @if (AuthService.IsAuthenticated)
    {
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-2" OnClick="ShowAddDialog">Ajouter une recette</MudButton>
    }
</MudPaper>

<style>
    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .recipe-table tbody tr {
        transition: background-color 0.2s ease, transform 0.1s ease;
    }
    
    .recipe-table tbody tr:hover {
        transform: translateX(2px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Rating-based row colors */
    .rating-5-row { background-color: rgba(76, 175, 80, 0.08) !important; }
    .rating-4-row { background-color: rgba(33, 150, 243, 0.08) !important; }
    .rating-3-row { background-color: rgba(255, 152, 0, 0.08) !important; }
    .rating-2-row { background-color: rgba(158, 158, 158, 0.08) !important; }
    .rating-1-row { background-color: rgba(244, 67, 54, 0.08) !important; }
    .rating-0-row { background-color: rgba(117, 117, 117, 0.05) !important; }
    
    /* Hover states for rating colors */
    .recipe-table tbody tr.rating-5-row:hover { background-color: rgba(76, 175, 80, 0.15) !important; }
    .recipe-table tbody tr.rating-4-row:hover { background-color: rgba(33, 150, 243, 0.15) !important; }
    .recipe-table tbody tr.rating-3-row:hover { background-color: rgba(255, 152, 0, 0.15) !important; }
    .recipe-table tbody tr.rating-2-row:hover { background-color: rgba(158, 158, 158, 0.15) !important; }
    .recipe-table tbody tr.rating-1-row:hover { background-color: rgba(244, 67, 54, 0.15) !important; }
    .recipe-table tbody tr.rating-0-row:hover { background-color: rgba(117, 117, 117, 0.12) !important; }
</style>

@code {
    private MudTable<Recipe>? table;
    private List<Book> books = [];
    private List<Author> authors = [];
    private List<BreadcrumbItem> breadcrumbs =>
    [
        new BreadcrumbItem("Accueil", href: ""),
        new BreadcrumbItem("Recettes", href: "/recipes", disabled: true)
    ];
    private string searchTerm = string.Empty;
    private string? ratingFilter;
    private string? bookFilter;
    private string? authorFilter;
    
    // Quick filter state
    private bool showAllRecipes = true;
    private int? quickFilterRating = null;
    private bool quickFilterUnrated = false;
    
    // Filter counts
    private int totalCount = 0;
    private int fiveStarCount = 0;
    private int fourPlusStarCount = 0;
    private int unratedCount = 0;
    private Dictionary<int, int> bookRecipeCounts = new();
    private Dictionary<int, int> authorRecipeCounts = new();
    
    // Card view state
    private bool _isCardView = false;
    private bool isCardView 
    { 
        get => _isCardView;
        set
        {
            if (_isCardView != value)
            {
                _isCardView = value;
                _ = OnViewModeChanged();
            }
        }
    }
    
    private async Task OnViewModeChanged()
    {
        await SaveViewPreference();
        
        if (isCardView)
        {
            currentPage = 1;
            await LoadCardViewData();
        }
        else
        {
            await Reload();
        }
    }
    
    private bool isLoading = true;
    private List<Recipe> currentRecipes = new();
    private int currentPage = 1;
    private int pageSize = 12;
    private int totalPages = 0;
    private const string ViewModeKey = "recipeViewMode";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load view preference from localStorage first
            await LoadViewPreference();
            
            // Load recipes and filter data
            await LoadRecipes();
            await LoadFilterCounts();
            
            // Load data based on view mode
            if (isCardView)
            {
                await LoadCardViewData();
            }
            else
            {
                // For table view, set loading to false since table handles its own loading
                isLoading = false;
            }
        }
        catch (Exception ex)
        {
            // Log error if needed
            isLoading = false;
        }
    }

    private async Task LoadViewPreference()
    {
        try
        {
            var viewMode = await JSRuntime.InvokeAsync<string>("localStorage.getItem", ViewModeKey);
            _isCardView = viewMode == "card"; // Set directly to avoid triggering OnViewModeChanged
        }
        catch
        {
            _isCardView = false;
        }
    }
    
    private async Task SaveViewPreference()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", ViewModeKey, isCardView ? "card" : "table");
        }
        catch
        {
            // Silently fail if localStorage is not available
        }
    }

    private async Task LoadRecipes()
    {
        books = (await RecipeService.GetBooksAsync())?.ToList() ?? new();
        authors = (await RecipeService.GetAuthorsAsync())?.ToList() ?? new();
        
        if (!isCardView)
        {
            await Reload();
        }
    }

    private async Task LoadFilterCounts()
    {
        // Load all recipes to calculate counts
        var result = await RecipeService.SearchAsync(null, null, null, null, 1, 10000);
        if (result.IsSuccess)
        {
            var allRecipes = result.Value.Items;
            totalCount = allRecipes.Count;
            fiveStarCount = allRecipes.Count(r => r.Rating == 5);
            fourPlusStarCount = allRecipes.Count(r => r.Rating >= 4);
            unratedCount = allRecipes.Count(r => r.Rating == 0 || r.Rating < 1);
            
            // Calculate book counts
            bookRecipeCounts = allRecipes
                .Where(r => r.BookId.HasValue)
                .GroupBy(r => r.BookId!.Value)
                .ToDictionary(g => g.Key, g => g.Count());
            
            // Calculate author counts (through books)
            authorRecipeCounts = new Dictionary<int, int>();
            foreach (var author in authors)
            {
                var authorBookIds = books.Where(b => b.Authors.Any(a => a.Id == author.Id)).Select(b => b.Id).ToHashSet();
                var count = allRecipes.Count(r => r.BookId.HasValue && authorBookIds.Contains(r.BookId.Value));
                authorRecipeCounts[author.Id] = count;
            }
        }
    }

    private async Task LoadCardViewData()
    {
        isLoading = true;
        try
        {
            // Apply filters
            int? rating = GetRatingFilter();
            int? bookId = GetBookIdFilter();
            int? authorId = GetAuthorIdFilter();
            
            var result = await RecipeService.SearchAsync(
                searchTerm,
                rating,
                bookId,
                authorId,
                currentPage,
                pageSize,
                "created_at",
                true
            );
            
            if (result.IsSuccess)
            {
                currentRecipes = result.Value.Items.ToList();
                totalPages = (int)Math.Ceiling(result.Value.Total / (double)pageSize);
            }
            else
            {
                currentRecipes = new();
                totalPages = 0;
            }
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private int? GetRatingFilter()
    {
        if (quickFilterUnrated)
            return null; // Handle unrated in post-processing
        if (quickFilterRating.HasValue && quickFilterRating.Value != 4)
            return quickFilterRating.Value;
        if (ratingFilter != "all" && !string.IsNullOrWhiteSpace(ratingFilter))
            return int.TryParse(ratingFilter, out var r) ? r : null;
        return null;
    }
    
    private int? GetBookIdFilter()
    {
        return (bookFilter == "all" || string.IsNullOrWhiteSpace(bookFilter)) 
            ? null 
            : (int.TryParse(bookFilter, out var b) ? b : null);
    }
    
    private int? GetAuthorIdFilter()
    {
        return (authorFilter == "all" || string.IsNullOrWhiteSpace(authorFilter)) 
            ? null 
            : (int.TryParse(authorFilter, out var a) ? a : null);
    }

    private int GetRecipeCountForBook(int bookId) => bookRecipeCounts.GetValueOrDefault(bookId, 0);
    private int GetRecipeCountForAuthor(int authorId) => authorRecipeCounts.GetValueOrDefault(authorId, 0);

    private bool HasActiveFilters()
    {
        return !string.IsNullOrWhiteSpace(searchTerm) 
            || (ratingFilter != null && ratingFilter != "all") 
            || (bookFilter != null && bookFilter != "all") 
            || (authorFilter != null && authorFilter != "all");
    }
    
    private string GetEmptyStateTitle()
    {
        if (HasActiveFilters())
            return "Aucune recette trouv√©e";
        return "Aucune recette pour le moment";
    }
    
    private string GetEmptyStateMessage()
    {
        if (HasActiveFilters())
            return "Essayez de modifier vos filtres ou r√©initialisez-les pour voir toutes les recettes.";
        return "Commencez par ajouter votre premi√®re recette pour construire votre collection personnelle.";
    }

    private async Task ShowAll()
    {
        showAllRecipes = true;
        quickFilterRating = null;
        quickFilterUnrated = false;
        ratingFilter = null;
        currentPage = 1;
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ApplyQuickFilter(int rating)
    {
        showAllRecipes = false;
        quickFilterRating = rating;
        quickFilterUnrated = false;
        ratingFilter = rating >= 4 ? null : rating.ToString();
        currentPage = 1;
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ShowUnrated()
    {
        showAllRecipes = false;
        quickFilterRating = null;
        quickFilterUnrated = true;
        ratingFilter = null;
        currentPage = 1;
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ClearAllFilters()
    {
        searchTerm = string.Empty;
        ratingFilter = null;
        bookFilter = null;
        authorFilter = null;
        showAllRecipes = true;
        quickFilterRating = null;
        quickFilterUnrated = false;
        currentPage = 1;
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ClearSearch()
    {
        searchTerm = string.Empty;
        currentPage = 1;
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ClearRating()
    {
        ratingFilter = null;
        quickFilterRating = null;
        quickFilterUnrated = false;
        showAllRecipes = true;
        currentPage = 1;
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ClearBook()
    {
        bookFilter = null;
        currentPage = 1;
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ClearAuthor()
    {
        authorFilter = null;
        currentPage = 1;
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task ShowAddDialog()
    {
        var dialog = await DialogService.ShowAsync<AddRecipeDialog>("Ajouter une recette");
        var result = await dialog.Result;
        if (result is not null && !result.Canceled)
        {
            await LoadRecipes();
            await LoadFilterCounts();
            
            if (isCardView)
            {
                await LoadCardViewData();
            }
            
            Snackbar.Add("Recette ajout√©e avec succ√®s!", Severity.Success);
        }
    }

    private async Task ShowEditDialog(Recipe recipeToEdit)
    {
        var parameters = new MudBlazor.DialogParameters { ["RecipeToEdit"] = recipeToEdit };
        var dialog = await DialogService.ShowAsync<EditRecipeDialog>("Modifier la recette", parameters);
        var result = await dialog.Result;
        if (result is not null && !result.Canceled)
        {
            await LoadRecipes();
            await LoadFilterCounts();
            
            if (isCardView)
            {
                await LoadCardViewData();
            }
            
            Snackbar.Add("Recette modifi√©e avec succ√®s!", Severity.Success);
        }
    }

    private async Task DeleteRecipe(Recipe recipeToDelete)
    {
        try
        {
            bool? confirm = await DialogService.ShowMessageBox(
                "Confirmer la suppression",
                $"√ätes-vous s√ªr de vouloir supprimer la recette '{recipeToDelete.Name}' ? Cette action est irr√©versible.",
                yesText: "Supprimer",
                cancelText: "Annuler");

            if (confirm != true)
            {
                return;
            }

            var res = await RecipeService.DeleteAsync(recipeToDelete.Id);
            if (res.IsSuccess)
            {
                Snackbar.Add($"La recette '{recipeToDelete.Name}' a √©t√© supprim√©e avec succ√®s.", Severity.Success);
                
                if (isCardView)
                {
                    await LoadCardViewData();
                }
                else
                {
                    await Reload();
                }
                
                await LoadFilterCounts();
            }
            else
            {
                Snackbar.Add(res.ErrorMessage ?? "Une erreur s'est produite lors de la suppression de la recette.", Severity.Error);
            }
        }
        catch (Exception)
        {
            Snackbar.Add("Une erreur s'est produite lors de la suppression de la recette. Veuillez r√©essayer.", Severity.Error);
        }
    }

    private async Task<TableData<Recipe>> LoadServerData(TableState state, CancellationToken token)
    {
        var page = state.Page + 1;
        var pageSize = state.PageSize;
        
        // Apply quick filters
        int? rating = null;
        if (quickFilterUnrated)
        {
            // We'll handle unrated filter in post-processing
        }
        else if (quickFilterRating.HasValue)
        {
            if (quickFilterRating.Value == 4)
            {
                // For 4+, we'll filter in post-processing
            }
            else
            {
                // For exact rating (5, 3, 2, 1), pass to search
                rating = quickFilterRating.Value;
            }
        }
        else if (ratingFilter != "all" && !string.IsNullOrWhiteSpace(ratingFilter))
        {
            rating = int.TryParse(ratingFilter, out var r) ? r : null;
        }
        
        int? bookId = (bookFilter == "all" || string.IsNullOrWhiteSpace(bookFilter)) ? null : (int.TryParse(bookFilter, out var b) ? b : null);
        int? authorId = (authorFilter == "all" || string.IsNullOrWhiteSpace(authorFilter)) ? null : (int.TryParse(authorFilter, out var a) ? a : null);
        
        var sortLabel = state.SortLabel;
        var sortDescending = state.SortDirection == SortDirection.Descending;
        
        var result = await RecipeService.SearchAsync(searchTerm, rating, bookId, authorId, page, pageSize, sortLabel, sortDescending);
        if (!result.IsSuccess)
            return new TableData<Recipe> { Items = Array.Empty<Recipe>(), TotalItems = 0 };
        
        var items = result.Value.Items;
        var total = result.Value.Total;
        
        // Post-process for special filters
        if (quickFilterUnrated)
        {
            items = items.Where(r => r.Rating == 0 || r.Rating < 1).ToList();
            total = items.Count;
        }
        else if (quickFilterRating == 4)
        {
            // Only filter 4+ stars in post-processing
            items = items.Where(r => r.Rating >= 4).ToList();
            total = items.Count;
        }
        
        return new TableData<Recipe> { Items = items, TotalItems = total };
    }

    private async Task Reload()
    {
        if (table is not null)
        {
            await table.ReloadServerData();
        }
    }

    private async Task OnRatingChanged(string? value)
    {
        ratingFilter = value;
        showAllRecipes = false;
        quickFilterRating = null;
        quickFilterUnrated = false;
        currentPage = 1;
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task OnBookChanged(string? value)
    {
        bookFilter = value;
        currentPage = 1;
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task OnAuthorChanged(string? value)
    {
        authorFilter = value;
        currentPage = 1;
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }

    private async Task OnSearchChanged(string value)
    {
        searchTerm = value;
        currentPage = 1;
        
        if (isCardView)
            await LoadCardViewData();
        else
            await Reload();
    }
    
    private async Task OnPageChanged(int page)
    {
        currentPage = page;
        await LoadCardViewData();
        StateHasChanged();
    }
    
    private void ViewRecipe(Recipe recipe)
    {
        NavigationManager.NavigateTo($"/recipes/{recipe.Id}");
    }
    
    private void PrintRecipe(Recipe recipe)
    {
        NavigationManager.NavigateTo($"/recipes/{recipe.Id}/print");
    }

    private string GetRowStyle(Recipe recipe)
    {
        // Apply subtle background color based on rating
        return recipe.Rating switch
        {
            5 => "background-color: rgba(76, 175, 80, 0.08);",
            4 => "background-color: rgba(33, 150, 243, 0.08);",
            3 => "background-color: rgba(255, 152, 0, 0.08);",
            2 => "background-color: rgba(158, 158, 158, 0.08);",
            1 => "background-color: rgba(244, 67, 54, 0.08);",
            _ => "background-color: rgba(117, 117, 117, 0.05);"
        };
    }
}
