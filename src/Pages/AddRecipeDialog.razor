@using MudBlazor
@using RecettesIndex.Models
@using RecettesIndex.Services.Abstractions
@using Microsoft.Extensions.Logging
@inject IRecipeService RecipeService
@inject ISnackbar Snackbar
@inject ILogger<AddRecipeDialog> Logger

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6">Ajouter une Recette</MudText>
        <MudTextField @bind-Value="recipe.Name" Label="Nom" Required="true" Variant="Variant.Outlined" Class="mb-2" />
        <PizzaRating @bind-Value="recipe.Rating" ReadOnly="false" />
        <MudTextField @bind-Value="recipe.Notes" Label="Notes" Variant="Variant.Outlined" Class="mb-2" />
        <MudTextField @bind-Value="bookRef" Label="Référence du livre (optionnel)" Variant="Variant.Outlined" Class="mb-2" />
        <MudNumericField @bind-Value="recipe.BookPage" Label="Page du livre (optionnel)" Variant="Variant.Outlined" Class="mb-2" />
        <MudSelect T="Book" Label="Livre (optionnel)" @bind-Value="selectedBook" Variant="Variant.Outlined" Class="mb-2">
            <MudSelectItem T="Book" Value="null">Aucun</MudSelectItem>
            @foreach (var book in books)
            {
                <MudSelectItem T="Book" Value="book">@book.Name</MudSelectItem>
            }
        </MudSelect>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error">@errorMessage</MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="AddRecipeAsync" Color="Color.Primary" Variant="Variant.Filled" Disabled="@isSaving">
            @if (isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
            }
            else
            {
                <span>Ajouter</span>
            }
        </MudButton>
        <MudButton OnClick="Cancel" Color="Color.Secondary" Variant="Variant.Text" Disabled="@isSaving">Annuler</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    public required IMudDialogInstance MudDialog { get; set; }
    
    private readonly Recipe recipe = new() { CreationDate = DateTime.UtcNow };
    private string? bookRef;
    private string? errorMessage;
    private List<Book> books = [];
    private Book? selectedBook;
    private bool isSaving = false;

    protected override async Task OnInitializedAsync()
    {
        // Use service layer instead of direct Supabase client
        // This leverages caching (3-minute TTL) and proper error handling
        books = (await RecipeService.GetBooksAsync())?.ToList() ?? [];
    }

    private async Task AddRecipeAsync()
    {
        errorMessage = null;
        isSaving = true;
        
        try
        {
            // Validate input
            if (string.IsNullOrWhiteSpace(recipe.Name))
            {
                errorMessage = "Le nom de la recette est requis.";
                return;
            }

            // Set book reference if selected
            recipe.BookId = selectedBook?.Id;
            
            // Use service layer for creation
            var result = await RecipeService.CreateAsync(recipe);
            
            if (result.IsSuccess)
            {
                Snackbar.Add("Recette ajoutée avec succès!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(result.Value));
            }
            else
            {
                errorMessage = result.ErrorMessage ?? "Échec lors de l'ajout de la recette.";
                Snackbar.Add(errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Unexpected error adding recipe");
            errorMessage = "Une erreur inattendue s'est produite.";
            Snackbar.Add(errorMessage, Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }
    
    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
