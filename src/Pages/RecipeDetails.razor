@page "/recipes/{Id:int}"
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Logging
@using MudBlazor
@using RecettesIndex.Models
@using RecettesIndex.Services
@using RecettesIndex.Components
@using Supabase
@inject AuthService AuthService
@inject IDialogService DialogService
@inject ILogger<RecipeDetails> Logger
@inject NavigationManager NavigationManager
@inject Client SupabaseClient
@inject LocalStorageService LocalStorage
@inject ISnackbar Snackbar

<PageTitle>Recette - @(recipe?.Name ?? "Chargement...")</PageTitle>
<MudBreadcrumbs Items="breadcrumbs" Class="mb-4" />

@if (loading)
{
    <MudContainer Class="d-flex flex-column align-center py-8">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        <MudText Typo="Typo.h6" Class="mt-4">Chargement de la recette...</MudText>
    </MudContainer>
}
else if (recipe == null)
{
    <MudAlert Severity="Severity.Error" Class="my-4">Recette introuvable.</MudAlert>
}
else
{
    <HeroSection Title="@recipe.Name" 
                 Subtitle="@GetAdditionalInfo()"
                 AdditionalInfo=""
                 Icon="@Icons.Material.Filled.Restaurant">
        <RightContent>
            <MudStack Spacing="3" AlignItems="AlignItems.Center">
                <!-- Favorite Toggle -->
                <div>
                    <MudText Typo="Typo.subtitle2" Color="Color.Surface" Style="opacity: 0.9;" Class="mb-2" Align="Align.Center">
                        Favori
                    </MudText>
                    <MudTooltip Text="@(favoriteRecipeIds.Contains(recipe.Id) ? "Retirer des favoris" : "Ajouter aux favoris")">
                        <MudIconButton Icon="@(favoriteRecipeIds.Contains(recipe.Id) ? Icons.Material.Filled.Favorite : Icons.Material.Filled.FavoriteBorder)"
                                       Color="@(favoriteRecipeIds.Contains(recipe.Id) ? Color.Error : Color.Default)"
                                       Size="Size.Large"
                                       OnClick="@(() => ToggleFavorite(recipe))"
                                       Style="background-color: rgba(255,255,255,0.95); box-shadow: 0 2px 8px rgba(0,0,0,0.3); border-radius: 50%;" />
                    </MudTooltip>
                </div>
                
                <!-- Rating -->
                @if (recipe.Rating > 0)
                {
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Surface" Style="opacity: 0.9;" Class="mb-2" Align="Align.Center">
                            Évaluation
                        </MudText>
                        <PizzaRating ReadOnly="true" Value="@recipe.Rating" />
                    </div>
                }
            </MudStack>
        </RightContent>
    </HeroSection>

    <ActionBar BackUrl="/recipes" 
               BackText="Retour aux recettes"
               ShowEditButton="true"
               ShowPrintButton="true"
               PrintUrl="@($"/recipes/{Id}/print")"
               IsAuthenticated="@AuthService.IsAuthenticated"
               OnEditClick="@OpenEditDialog" />

    <MudGrid>
        <MudItem xs="12">
            <MudCard Elevation="3">
                <MudCardContent>
                    <MudTabs Rounded="true" Elevation="2" ApplyEffectsToContainer="true">
                        <MudTabPanel Text="Détails" Icon="@Icons.Material.Filled.Info">
                            <MudGrid>
                                <MudItem xs="12" md="6">
                                    @if (!string.IsNullOrEmpty(recipe.Notes))
                                    {
                                        <MudPaper Elevation="0" Class="pa-4 mud-background-gray rounded-lg">
                                            <MudText Typo="Typo.subtitle1"><MudIcon Icon="@Icons.Material.Filled.Notes" Class="mr-2" />Notes</MudText>
                                            <MudText Typo="Typo.body1" Style="white-space: pre-line">@recipe.Notes</MudText>
                                        </MudPaper>
                                    }
                                    else
                                    {
                                        <MudAlert Severity="Severity.Info" Class="mt-3">Aucune note pour cette recette.</MudAlert>
                                    }
                                </MudItem>
                                <MudItem xs="12" md="6">
                                    <MudPaper Elevation="0" Class="pa-4 rounded-lg">
                                        <MudText Typo="Typo.subtitle1"><MudIcon Icon="@Icons.Material.Filled.Book" Class="mr-2" />Informations sur la source</MudText>
                                        @if (book != null)
                                        {
                                            <MudList Dense="true" T="Recipe">
                                                <MudListItem Icon="@Icons.Material.Filled.Book">
                                                    <MudText>Livre: <MudLink Href="@($"/books/{book.Id}")">@book.Name</MudLink></MudText>
                                                </MudListItem>
                                                
                                                @if (recipe.BookPage != null)
                                                {
                                                    <MudListItem Icon="@Icons.Material.Filled.MenuBook">
                                                        <MudText>Page: @recipe.BookPage</MudText>
                                                    </MudListItem>
                                                }
                                                
                                                @if (book.Authors != null && book.Authors.Count > 0)
                                                {
                                                    <MudListItem Icon="@Icons.Material.Filled.Person">
                                                        <MudText>
                                                            Auteur(s):
                                                            @foreach (var author in book.Authors)
                                                            {
                                                                <MudLink Href="@($"/authors/{author.Id}")" Class="mr-2">@author.Name @author.LastName</MudLink>
                                                            }
                                                        </MudText>
                                                    </MudListItem>
                                                }
                                            </MudList>
                                        }
                                        else if (store != null)
                                        {
                                            <MudList Dense="true" T="Recipe">
                                                <MudListItem Icon="@Icons.Material.Filled.Storefront">
                                                    <MudText>Magasin: <MudLink Href="@($"/stores/{store.Id}")">@store.Name</MudLink></MudText>
                                                </MudListItem>
                                                
                                                @if (!string.IsNullOrWhiteSpace(store.Address))
                                                {
                                                    <MudListItem Icon="@Icons.Material.Filled.LocationOn">
                                                        <MudText>Adresse: @store.Address</MudText>
                                                    </MudListItem>
                                                }
                                                
                                                @if (!string.IsNullOrWhiteSpace(store.Phone))
                                                {
                                                    <MudListItem Icon="@Icons.Material.Filled.Phone">
                                                        <MudText>Téléphone: <MudLink Href="@($"tel:{store.Phone}")">@store.Phone</MudLink></MudText>
                                                    </MudListItem>
                                                }
                                                
                                                @if (!string.IsNullOrWhiteSpace(store.Website))
                                                {
                                                    <MudListItem Icon="@Icons.Material.Filled.Language">
                                                        <MudText>Site Web: <MudLink Href="@store.Website" Target="_blank">Visiter</MudLink></MudText>
                                                    </MudListItem>
                                                }
                                            </MudList>
                                        }
                                        else
                                        {
                                            <MudAlert Severity="Severity.Info">
                                                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                                    <MudIcon Icon="@Icons.Material.Filled.Home" Size="Size.Small" />
                                                    <span>Recette maison (aucune source associée)</span>
                                                </MudStack>
                                            </MudAlert>
                                        }
                                    </MudPaper>
                                </MudItem>
                            </MudGrid>
                        </MudTabPanel>
                    </MudTabs>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <!-- Related Recipes Section -->
        @if (relatedRecipes.Any())
        {
            <MudItem xs="12" Class="mt-4">
                <MudText Typo="Typo.h5" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Class="mr-2" />
                    Recettes Similaires
                </MudText>
                <MudGrid Spacing="3">
                    @foreach (var relatedRecipe in relatedRecipes)
                    {
                        <MudItem xs="12" sm="6" md="4" lg="2">
                            <RecipeCard Recipe="@relatedRecipe"
                                       Book="@relatedRecipe.Book"
                                       IsAuthenticated="@AuthService.IsAuthenticated"
                                       IsFavorite="@favoriteRecipeIds.Contains(relatedRecipe.Id)"
                                       OnView="@HandleViewRelatedRecipe"
                                       OnEdit="@(async (r) => await Task.CompletedTask)"
                                       OnDelete="@(async (r) => await Task.CompletedTask)"
                                       OnPrint="@HandlePrintRelatedRecipe"
                                       OnToggleFavorite="@ToggleFavorite" />
                        </MudItem>
                    }
                </MudGrid>
                
                @if (HasMoreRelatedRecipes())
                {
                    <div class="d-flex justify-center mt-4">
                        <MudButton Variant="Variant.Outlined" 
                                  Color="Color.Primary"
                                  StartIcon="@Icons.Material.Filled.ArrowForward"
                                  Href="@GetMoreRecipesUrl()">
                            Voir plus de recettes similaires
                        </MudButton>
                    </div>
                }
            </MudItem>
        }
    </MudGrid>
}

@code {
    [Parameter] 
    public int Id { get; set; }
    
    private Recipe? recipe;
    private Book? book;
    private Store? store;
    private bool loading = true;
    private List<Recipe> relatedRecipes = new();
    private List<int> favoriteRecipeIds = new();
    private List<BreadcrumbItem> breadcrumbs =
    [
        new BreadcrumbItem("Accueil", href: "/" ),
        new BreadcrumbItem("Recettes", href: "/recipes"),
        new BreadcrumbItem("Détails", href: null, disabled: true)
    ];
    
    protected override async Task OnInitializedAsync()
    {
        // Load favorites from localStorage
        favoriteRecipeIds = await LocalStorage.GetFavoritesAsync();
        
        await LoadRecipeData();
    }
    
    protected override async Task OnParametersSetAsync()
    {
        // This is called when the route parameters change (e.g., navigating from recipe 1 to recipe 2)
        // We need to reload the data when the Id changes
        await LoadRecipeData();
    }
    
    private async Task LoadRecipeData()
    {
        loading = true;
        
        try 
        {
            var response = await SupabaseClient.From<Recipe>().Where(x => x.Id == Id).Get();
            recipe = response.Models?.FirstOrDefault();
            
            if (recipe != null)
            {
                // Update the breadcrumbs with recipe name
                breadcrumbs[2] = new BreadcrumbItem(recipe.Name, href: null, disabled: true);
                
                // Load book if recipe is from a book
                if (recipe.BookId != null)
                {
                    var bookResponse = await SupabaseClient.From<Book>().Where(x => x.Id == recipe.BookId).Get();
                    book = bookResponse.Models?.FirstOrDefault();
                }
                
                // Load store if recipe is from a store
                if (recipe.StoreId != null)
                {
                    var storeResponse = await SupabaseClient.From<Store>().Where(x => x.Id == recipe.StoreId).Get();
                    store = storeResponse.Models?.FirstOrDefault();
                }
                
                // Load related recipes
                await LoadRelatedRecipes();
                
                // Track this recipe in recent recipes
                await LocalStorage.AddRecentRecipeAsync(recipe.Id, recipe.Name);
            }
        }
        catch (Exception ex)
        {
            // Add error handling if needed
            Logger.LogError(ex, "Error loading recipe {RecipeId}", Id);
        }
        finally
        {
            loading = false;
        }
    }
    
    private async Task LoadRelatedRecipes()
    {
        if (recipe == null) return;
        
        try
        {
            // Load all recipes to calculate similarity
            var allRecipesResponse = await SupabaseClient.From<Recipe>().Get();
            var allRecipes = allRecipesResponse.Models ?? new List<Recipe>();
            
            // Calculate similarity scores
            var scoredRecipes = allRecipes
                .Where(r => r.Id != recipe.Id) // Exclude current recipe
                .Select(r => new
                {
                    Recipe = r,
                    Score = CalculateSimilarityScore(r)
                })
                .Where(x => x.Score > 0) // Only include recipes with some similarity
                .OrderByDescending(x => x.Score)
                .Take(6)
                .Select(x => x.Recipe)
                .ToList();
            
            relatedRecipes = scoredRecipes;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading related recipes for {RecipeId}", Id);
            relatedRecipes = new List<Recipe>();
        }
    }
    
    private int CalculateSimilarityScore(Recipe candidate)
    {
        if (recipe == null) return 0;
        
        int score = 0;
        
        // Same book (highest priority) - 100 points
        if (candidate.BookId.HasValue && candidate.BookId == recipe.BookId)
        {
            score += 100;
        }
        
        // Same store (highest priority) - 100 points
        if (candidate.StoreId.HasValue && candidate.StoreId == recipe.StoreId)
        {
            score += 100;
        }
        
        // Same author (medium priority) - 50 points
        if (book != null && candidate.Book != null)
        {
            var currentAuthorIds = book.Authors?.Select(a => a.Id).ToHashSet() ?? new HashSet<int>();
            var candidateAuthorIds = candidate.Book.Authors?.Select(a => a.Id).ToHashSet() ?? new HashSet<int>();
            
            if (currentAuthorIds.Any() && candidateAuthorIds.Any() && currentAuthorIds.Overlaps(candidateAuthorIds))
            {
                score += 50;
            }
        }
        
        // Similar rating (low priority) - 10-20 points
        if (recipe.Rating > 0 && candidate.Rating > 0)
        {
            var ratingDifference = Math.Abs(recipe.Rating - candidate.Rating);
            
            if (ratingDifference == 0)
            {
                score += 20; // Exact same rating
            }
            else if (ratingDifference == 1)
            {
                score += 10; // One star difference
            }
            // No points for 2+ star difference
        }
        
        return score;
    }
    
    private bool HasMoreRelatedRecipes()
    {
        // Check if there are potentially more related recipes
        // For now, show button if we have 6 recipes (indicating there might be more)
        return relatedRecipes.Count >= 6 && (recipe?.BookId != null || recipe?.StoreId != null);
    }
    
    private string GetMoreRecipesUrl()
    {
        // Link to recipes page filtered by same book or store
        if (recipe?.BookId != null)
        {
            return $"/recipes?bookId={recipe.BookId}";
        }
        else if (recipe?.StoreId != null)
        {
            return $"/recipes?storeId={recipe.StoreId}";
        }
        
        return "/recipes";
    }
    
    private void NavigateToRecipe(int recipeId)
    {
        NavigationManager.NavigateTo($"/recipes/{recipeId}");
    }
    
    private async Task HandleViewRelatedRecipe(Recipe relatedRecipe)
    {
        // Navigate to the related recipe
        NavigationManager.NavigateTo($"/recipes/{relatedRecipe.Id}");
        await Task.CompletedTask;
    }
    
    private async Task HandlePrintRelatedRecipe(Recipe relatedRecipe)
    {
        // Navigate to print view
        NavigationManager.NavigateTo($"/recipes/{relatedRecipe.Id}/print");
        await Task.CompletedTask;
    }
    
    private async Task ToggleFavorite(Recipe recipeToToggle)
    {
        await LocalStorage.ToggleFavoriteAsync(recipeToToggle.Id);
        
        // Refresh favorites list
        favoriteRecipeIds = await LocalStorage.GetFavoritesAsync();
        
        StateHasChanged();
        
        // Show toast notification
        var isFavorite = favoriteRecipeIds.Contains(recipeToToggle.Id);
        Snackbar.Add(
            isFavorite ? $"'{recipeToToggle.Name}' ajouté aux favoris ❤️" : $"'{recipeToToggle.Name}' retiré des favoris",
            isFavorite ? Severity.Success : Severity.Info
        );
    }
    
    private async Task OpenEditDialog()
    {
        if (recipe != null)
        {
            var parameters = new DialogParameters();
            parameters.Add("RecipeToEdit", recipe);
            
            var dialog = await DialogService.ShowAsync<EditRecipeDialog>("Modifier la recette", parameters);
            var result = await dialog.Result;
            
            if (result is not null && !result.Canceled && result.Data is Recipe updatedRecipe)
            {
                // Refresh the recipe data
                recipe = updatedRecipe;
                StateHasChanged();
            }
        }
    }

    private string GetAdditionalInfo()
    {
        var info = new List<string>();
        
        if (book != null)
        {
            info.Add($"Livre: {book.Name}");
            
            if (recipe?.BookPage != null)
            {
                info.Add($"Page: {recipe.BookPage}");
            }
        }
        else if (store != null)
        {
            info.Add($"Magasin: {store.Name}");
        }

        return string.Join(" • ", info);
    }
}
