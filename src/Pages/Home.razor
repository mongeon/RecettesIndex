@page "/"
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Logging
@using MudBlazor
@using RecettesIndex.Models
@using RecettesIndex.Services
@using RecettesIndex.Components
@using Supabase
@inject AuthService AuthService
@inject IDialogService DialogService
@inject NavigationManager NavigationManager
@inject Client SupabaseClient
@inject LocalStorageService LocalStorage
@inject ISnackbar Snackbar
@inject ILogger<Home> Logger

<PageTitle>Mes Recettes - Votre Collection de Recettes</PageTitle>

<!-- Hero Section -->
<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="px-0">
    <MudPaper Elevation="0" Class="hero-section rounded-lg mb-6 position-relative overflow-hidden">
        <div class="hero-overlay"></div>
        <MudContainer Class="py-8 py-md-16">
            <MudGrid>
                <MudItem xs="12" sm="10" md="8" lg="6">
                    <MudText Typo="Typo.h3" Color="Color.Surface" Style="font-weight: bold;" Class="mb-4 position-relative">D√©couvrez de D√©licieuses Recettes</MudText>
                    <MudText Typo="Typo.body1" Color="Color.Surface" Class="mb-6 position-relative" Style="font-size: 1.1rem;">
                        Votre collection personnelle de tr√©sors culinaires, organis√©e par livres et auteurs.
                    </MudText>
                    <div class="d-flex flex-column flex-sm-row gap-3 position-relative">
                        <MudButton Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Large" Href="/recipes" 
                                   StartIcon="@Icons.Material.Filled.MenuBook">
                            Parcourir les Recettes
                        </MudButton>
                        @if (AuthService.IsAuthenticated)
                        {
                            <MudButton Variant="Variant.Outlined" Color="Color.Surface" Size="Size.Large" 
                                       StartIcon="@Icons.Material.Filled.Add" OnClick="ShowAddRecipeDialog">
                                Ajouter une Recette
                            </MudButton>
                        }
                    </div>
                </MudItem>
            </MudGrid>
        </MudContainer>
    </MudPaper>

    <!-- Stats Cards -->
    <MudGrid Class="mb-6">
        <MudItem xs="12" sm="6" md="6">
            <MudPaper Elevation="2" Class="pa-4 pa-sm-6 rounded-lg h-100 d-flex flex-column">
                <div class="d-flex justify-center mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.Restaurant" Color="Color.Primary" Size="Size.Large" />
                </div>
                <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-2">@totalRecipesCount</MudText>
                <MudText Typo="Typo.subtitle1" Align="Align.Center" Color="Color.Primary">Recettes Totales</MudText>
                <MudSpacer />
                <MudButton Variant="Variant.Text" Color="Color.Primary" FullWidth="true" Href="/recipes">Voir Tout</MudButton>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="6">
            <MudPaper Elevation="2" Class="pa-4 pa-sm-6 rounded-lg h-100 d-flex flex-column">
                <div class="d-flex justify-center mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.AutoStories" Color="Color.Secondary" Size="Size.Large" />
                </div>
                <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-2">
                    @totalBooksCount
                </MudText>
                <MudText Typo="Typo.subtitle1" Align="Align.Center" Color="Color.Secondary">Livres de Recettes</MudText>
                <MudSpacer />
                <MudButton Variant="Variant.Text" Color="Color.Secondary" FullWidth="true" Href="/books">Voir Tout</MudButton>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Newest Recipes Section -->
    <MudText Typo="Typo.h4" Color="Color.Primary" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.NewReleases" Class="mr-2" /> Nouvelles Recettes
    </MudText>
    
    @if (loadingNewest)
    {
        <div class="d-flex justify-center my-8">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else if (newestRecipes.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="my-4">Aucune recette trouv√©e. Commencez par ajouter votre premi√®re recette!</MudAlert>
    }
    else
    {
        <div class="d-none d-sm-flex overflow-auto pb-4 gap-4 flex-nowrap mb-6 recipe-scroll">
            @foreach (var recipe in newestRecipes)
            {
                var book = allBooks.FirstOrDefault(b => b.Id == recipe.BookId);
                <div class="flex-shrink-0" style="width: 320px;">
                    <RecipeCard Recipe="@recipe"
                               Book="@book"
                               IsAuthenticated="@AuthService.IsAuthenticated"
                               IsFavorite="@favoriteRecipeIds.Contains(recipe.Id)"
                               OnView="@((r) => ShowRecipeDetails(r))"
                               OnEdit="@(async (r) => await Task.CompletedTask)"
                               OnDelete="@(async (r) => await Task.CompletedTask)"
                               OnPrint="@((r) => PrintRecipe(r))"
                               OnToggleFavorite="@ToggleFavorite" />
                </div>
            }
        </div>

        <!-- Vertical stacked grid for mobile -->
        <div class="d-block d-sm-none mb-6">
            <MudGrid>
                @foreach (var recipe in newestRecipes)
                {
                    var book = allBooks.FirstOrDefault(b => b.Id == recipe.BookId);
                    <MudItem xs="12">
                        <RecipeCard Recipe="@recipe"
                                   Book="@book"
                                   IsAuthenticated="@AuthService.IsAuthenticated"
                                   IsFavorite="@favoriteRecipeIds.Contains(recipe.Id)"
                                   OnView="@((r) => ShowRecipeDetails(r))"
                                   OnEdit="@(async (r) => await Task.CompletedTask)"
                                   OnDelete="@(async (r) => await Task.CompletedTask)"
                                   OnPrint="@((r) => PrintRecipe(r))"
                                   OnToggleFavorite="@ToggleFavorite" />
                    </MudItem>
                }
            </MudGrid>
        </div>
    }

    <!-- Random Recipes Section -->
    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h4" Color="Color.Secondary">
            <MudIcon Icon="@Icons.Material.Filled.Shuffle" Class="mr-2" /> D√©couvrez des Recettes Al√©atoires
        </MudText>
        
        <!-- Filter options for random recipes -->
        <MudStack Row Spacing="2" AlignItems="AlignItems.Center" Class="d-none d-sm-flex">
            <MudButtonGroup Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Small">
                <MudButton OnClick="() => SetRandomFilter(null)"
                          Variant="@(randomFilterRating == null ? Variant.Filled : Variant.Outlined)">
                    Toutes
                </MudButton>
                <MudButton OnClick="() => SetRandomFilter(5)"
                          Variant="@(randomFilterRating == 5 ? Variant.Filled : Variant.Outlined)"
                          StartIcon="@Icons.Material.Filled.Star">
                    5‚≠ê
                </MudButton>
                <MudButton OnClick="() => SetRandomFilter(4)"
                          Variant="@(randomFilterRating == 4 ? Variant.Filled : Variant.Outlined)"
                          StartIcon="@Icons.Material.Filled.Star">
                    4+‚≠ê
                </MudButton>
            </MudButtonGroup>
            
            <MudTooltip Text="Priorit√© des recettes">
                <MudToggleIconButton Toggled="@smartRandomization"
                                    ToggledChanged="@(async (bool val) => { smartRandomization = val; await OnSmartRandomizationChanged(val); })"
                                    Icon="@Icons.Material.Filled.Sort"
                                    ToggledIcon="@Icons.Material.Filled.AutoAwesome"
                                    Color="Color.Secondary"
                                    ToggledColor="Color.Tertiary"
                                    Size="Size.Small" />
            </MudTooltip>
        </MudStack>
    </MudStack>
    
    <!-- Mobile filter chips -->
    <div class="d-flex d-sm-none mb-3 gap-2 flex-wrap">
        <MudChip T="string" Size="Size.Small" 
                 Color="@(randomFilterRating == null ? Color.Secondary : Color.Default)"
                 OnClick="() => SetRandomFilter(null)">
            Toutes
        </MudChip>
        <MudChip T="string" Size="Size.Small"
                 Color="@(randomFilterRating == 5 ? Color.Secondary : Color.Default)"
                 Icon="@Icons.Material.Filled.Star"
                 OnClick="() => SetRandomFilter(5)">
            5‚≠ê
        </MudChip>
        <MudChip T="string" Size="Size.Small"
                 Color="@(randomFilterRating == 4 ? Color.Secondary : Color.Default)"
                 Icon="@Icons.Material.Filled.Star"
                 OnClick="() => SetRandomFilter(4)">
            4+‚≠ê
        </MudChip>
        <MudChip T="string" Size="Size.Small"
                 Color="@(smartRandomization ? Color.Tertiary : Color.Default)"
                 Icon="@(smartRandomization ? Icons.Material.Filled.AutoAwesome : Icons.Material.Filled.Sort)"
                 OnClick="async () => { smartRandomization = !smartRandomization; await OnSmartRandomizationChanged(smartRandomization); }">
            Smart
        </MudChip>
    </div>
    
    @if (loadingRandom)
    {
        <div class="d-flex justify-center my-8">
            <MudProgressCircular Color="Color.Secondary" Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else if (randomRecipes.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="my-4">
            @if (randomFilterRating.HasValue)
            {
                <text>Aucune recette @(randomFilterRating == 5 ? "5 √©toiles" : "4+ √©toiles") trouv√©e. Essayez un autre filtre!</text>
            }
            else
            {
                <text>Aucune recette trouv√©e. Commencez par ajouter votre premi√®re recette!</text>
            }
        </MudAlert>
    }
    else
    {
        <!-- Desktop: Horizontal scrollable cards -->
        <div class="d-none d-md-flex overflow-auto pb-4 gap-4 flex-nowrap mb-6 recipe-scroll @(refreshingRandom ? "fading-out" : "")">
            @foreach (var recipe in randomRecipes)
            {
                var book = allBooks.FirstOrDefault(b => b.Id == recipe.BookId);
                
                <div class="flex-shrink-0" style="width: 340px;">
                    <RecipeCard Recipe="@recipe"
                               Book="@book"
                               IsAuthenticated="@AuthService.IsAuthenticated"
                               IsFavorite="@favoriteRecipeIds.Contains(recipe.Id)"
                               OnView="@((r) => ShowRecipeDetails(r))"
                               OnEdit="@(async (r) => await Task.CompletedTask)"
                               OnDelete="@(async (r) => await Task.CompletedTask)"
                               OnPrint="@((r) => PrintRecipe(r))"
                               OnToggleFavorite="@ToggleFavorite" />
                </div>
            }
            
            <!-- Refresh button at the end -->
            <div class="flex-shrink-0 d-flex align-center" style="width: 100px;">
                <MudTooltip Text="Charger d'autres suggestions">
                    <MudFab Color="Color.Secondary" 
                            StartIcon="@Icons.Material.Filled.Refresh" 
                            Size="Size.Large"
                            OnClick="RefreshRandomRecipes"
                            Disabled="@refreshingRandom"
                            aria-label="Charger d'autres recettes" />
                </MudTooltip>
            </div>
        </div>

        <!-- Mobile/Tablet: Vertical stacked grid -->
        <div class="d-block d-md-none mb-6 @(refreshingRandom ? "fading-out" : "")">
            <MudGrid>
                @foreach (var recipe in randomRecipes)
                {
                    var book = allBooks.FirstOrDefault(b => b.Id == recipe.BookId);
                    <MudItem xs="12">
                        <RecipeCard Recipe="@recipe"
                                   Book="@book"
                                   IsAuthenticated="@AuthService.IsAuthenticated"
                                   IsFavorite="@favoriteRecipeIds.Contains(recipe.Id)"
                                   OnView="@((r) => ShowRecipeDetails(r))"
                                   OnEdit="@(async (r) => await Task.CompletedTask)"
                                   OnDelete="@(async (r) => await Task.CompletedTask)"
                                   OnPrint="@((r) => PrintRecipe(r))"
                                   OnToggleFavorite="@ToggleFavorite" />
                    </MudItem>
                }
            </MudGrid>
            
            <!-- Refresh button below cards on mobile -->
            <div class="d-flex justify-center mt-3">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Secondary" 
                          StartIcon="@Icons.Material.Filled.Refresh"
                          OnClick="RefreshRandomRecipes"
                          Disabled="@refreshingRandom">
                    Autres Suggestions
                </MudButton>
            </div>
        </div>
    }
</MudContainer>

<style>
    .hero-section {
        background-image: url('https://images.unsplash.com/photo-1499028344343-cd173ffc68a9?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1470&q=80');
        background-size: cover;
        background-position: center;
        color: white;
        min-height: 300px;
    }
    
    @@media (min-width: 768px) {
        .hero-section {
            min-height: 400px;
        }
    }
    
    .hero-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,107,107,0.9) 0%, rgba(255,107,107,0.7) 100%);
    }
    
    .recipe-scroll {
        scrollbar-width: thin;
        scrollbar-color: var(--mud-palette-primary) transparent;
        transition: opacity 0.3s ease-in-out;
    }
    
    .recipe-scroll::-webkit-scrollbar {
        height: 6px;
    }
    
    .recipe-scroll::-webkit-scrollbar-thumb {
        background-color: var(--mud-palette-primary);
        border-radius: 6px;
    }
    
    .recipe-scroll::-webkit-scrollbar-track {
        background: transparent;
    }
    
    /* Fade animation for refresh */
    .fading-out {
        opacity: 0.3;
        pointer-events: none;
    }
</style>

@code {
    private List<Recipe> newestRecipes = new();
    private List<Recipe> randomRecipes = new();
    private List<Book> allBooks = new();
    private List<int> favoriteRecipeIds = new();
    private bool loadingNewest = true;
    private bool loadingRandom = true;
    private bool refreshingRandom = false;
    private int totalRecipesCount = 0;
    private int totalBooksCount = 0;
    private int totalAuthorsCount = 0;
    
    // Random recipe filter settings
    private int? randomFilterRating = null;
    private bool smartRandomization = true;

    protected override async Task OnInitializedAsync()
    {
        // Load favorites first
        favoriteRecipeIds = await LocalStorage.GetFavoritesAsync();
        
        await LoadNewestRecipes();
        await LoadRandomRecipes();
        await LoadBooks();
        await LoadCounts();
    }

    private async Task LoadNewestRecipes()
    {
        loadingNewest = true;
        try
        {
            var response = await SupabaseClient.From<Recipe>().Order(x => x.CreationDate, Supabase.Postgrest.Constants.Ordering.Descending).Limit(5).Get();
            newestRecipes = response.Models ?? new List<Recipe>();
        }
        catch
        {
            newestRecipes = new List<Recipe>();
        }
        loadingNewest = false;
    }

    private async Task LoadRandomRecipes()
    {
        loadingRandom = true;
        try
        {
            var response = await SupabaseClient.From<Recipe>().Get();
            var allRecipes = response.Models ?? new List<Recipe>();
            
            // Apply rating filter
            if (randomFilterRating.HasValue)
            {
                // Use ternary operator to filter by rating
                allRecipes = (randomFilterRating.Value == 4)
                    ? allRecipes.Where(r => r.Rating >= 4).ToList()
                    : allRecipes.Where(r => r.Rating == randomFilterRating.Value).ToList();
            }
            
            if (allRecipes.Count == 0)
            {
                randomRecipes = new List<Recipe>();
                loadingRandom = false;
                return;
            }
            
            // Apply smart randomization (weighted by rating and recency)
            if (smartRandomization)
            {
                randomRecipes = SelectSmartRandomRecipes(allRecipes, UIConstants.RandomRecipeCount);
            }
            else
            {
                // Use Fisher-Yates shuffle for pure random selection
                randomRecipes = SelectPureRandomRecipes(allRecipes, UIConstants.RandomRecipeCount);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading random recipes with rating filter {Rating} and smart mode {SmartMode}", randomFilterRating, smartRandomization);
            randomRecipes = new List<Recipe>();
        }
        finally
        {
            loadingRandom = false;
        }
    }
    
    /// <summary>
    /// Selects random recipes using weighted randomization based on rating and recency.
    /// Higher rated and more recent recipes have higher probability of being selected.
    /// </summary>
    private List<Recipe> SelectSmartRandomRecipes(List<Recipe> recipes, int count)
    {
        var rnd = new Random();
        var selected = new List<Recipe>();
        var availableRecipes = new List<Recipe>(recipes);
        
        // Calculate weights for each recipe
        var weights = new Dictionary<Recipe, double>();
        var now = DateTime.UtcNow;
        
        foreach (var recipe in availableRecipes)
        {
            // Rating weight (0-1, normalized to 0.5-1.0 range)
            var ratingWeight = (recipe.Rating >= 1 && recipe.Rating <= 5)
                ? (recipe.Rating / 5.0 * 0.5) + 0.5 // Maps 1-5 stars to 0.6-1.0
                : 0.5; // Unrated or invalid ratings get base weight
            
            // Recency weight (recipes from last 90 days get bonus)
            var daysSinceCreation = (now - recipe.CreationDate).TotalDays;
            var recencyWeight = daysSinceCreation <= 90 
                ? 1.0 + (1.0 - (daysSinceCreation / 90.0)) * 0.3 // Up to 30% bonus for recent recipes
                : 1.0;
            
            // Favorite bonus
            var favoriteWeight = favoriteRecipeIds.Contains(recipe.Id) ? 1.1 : 1.0;
            
            // Combined weight
            weights[recipe] = ratingWeight * recencyWeight * favoriteWeight;
        }
        
        // Total weight for probability calculation
        var totalWeight = weights.Values.Sum();
        
        // Select recipes using weighted random selection
        var targetCount = Math.Min(count, availableRecipes.Count);
        for (int i = 0; i < targetCount; i++)
        {
            var randomValue = rnd.NextDouble() * totalWeight;
            var cumulativeWeight = 0.0;
            Recipe? selectedRecipe = null;
            
            foreach (var recipe in availableRecipes.ToList())
            {
                cumulativeWeight += weights[recipe];
                if (randomValue <= cumulativeWeight)
                {
                    selectedRecipe = recipe;
                    break;
                }
            }
            
            if (selectedRecipe != null)
            {
                selected.Add(selectedRecipe);
                availableRecipes.Remove(selectedRecipe);
                totalWeight -= weights[selectedRecipe];
                weights.Remove(selectedRecipe);
            }
        }
        
        return selected;
    }
    
    /// <summary>
    /// Selects random recipes using Fisher-Yates shuffle (pure random, no weighting).
    /// </summary>
    private List<Recipe> SelectPureRandomRecipes(List<Recipe> recipes, int count)
    {
        var rnd = new Random();
        var targetCount = Math.Min(count, recipes.Count);
        
        // Fisher-Yates shuffle in-place
        for (int i = 0; i < targetCount; i++)
        {
            int randomIndex = rnd.Next(i, recipes.Count);
            // Swap to avoid re-selecting
            (recipes[randomIndex], recipes[i]) = (recipes[i], recipes[randomIndex]);
        }
        
        // Return the first targetCount items
        return recipes.Take(targetCount).ToList();
    }
    
    private async Task RefreshRandomRecipes()
    {
        refreshingRandom = true;
        StateHasChanged();
        
        // Small delay for fade animation
        await Task.Delay(UIConstants.AnimationDelay);
        
        await LoadRandomRecipes();
        
        refreshingRandom = false;
        StateHasChanged();
        
        var filterText = randomFilterRating.HasValue 
            ? (randomFilterRating == 5 ? "5 √©toiles" : "4+ √©toiles")
            : "toutes cat√©gories";
        var modeText = smartRandomization ? "suggestions intelligentes" : "al√©atoires";
        
        Snackbar.Add($"Nouvelles {modeText} charg√©es ({filterText})! üé≤", Severity.Info);
    }
    
    private async Task SetRandomFilter(int? rating)
    {
        if (randomFilterRating != rating)
        {
            randomFilterRating = rating;
            await RefreshRandomRecipes();
        }
    }
    
    private async Task OnSmartRandomizationChanged(bool enabled)
    {
        smartRandomization = enabled;
        await RefreshRandomRecipes();
        
        if (enabled)
        {
            Snackbar.Add("Mode intelligent activ√© - priorit√© aux meilleures recettes r√©centes ‚ú®", Severity.Info);
        }
        else
        {
            Snackbar.Add("Mode al√©atoire pur activ√© üé≤", Severity.Info);
        }
    }
    
    private async Task ToggleFavoriteFromCard(Recipe recipe)
    {
        await LocalStorage.ToggleFavoriteAsync(recipe.Id);
        
        // Refresh favorites list
        favoriteRecipeIds = await LocalStorage.GetFavoritesAsync();
        
        StateHasChanged();
        
        // Show toast notification
        var isFavorite = favoriteRecipeIds.Contains(recipe.Id);
        Snackbar.Add(
            isFavorite ? $"‚ù§Ô∏è Ajout√© aux favoris" : $"Retir√© des favoris",
            isFavorite ? Severity.Success : Severity.Info
        );
    }

    private async Task LoadBooks()
    {
        try
        {
            var response = await SupabaseClient.From<Book>().Get();
            allBooks = response.Models ?? new List<Book>();
        }
        catch
        {
            allBooks = new List<Book>();
        }
    }

    private async Task LoadCounts()
    {
        try
        {
            // Get total recipes count - use a simple select with just id to minimize data transfer
            var recipesCountResponse = await SupabaseClient.From<Recipe>()
                .Select("id")
                .Get();
            totalRecipesCount = recipesCountResponse.Models?.Count ?? 0;

            // Get total books count - use a simple select with just id to minimize data transfer
            var booksCountResponse = await SupabaseClient.From<Book>()
                .Select("id")
                .Get();
            totalBooksCount = booksCountResponse.Models?.Count ?? 0;

            // Get total authors count - use a simple select with just id to minimize data transfer
            var authorsCountResponse = await SupabaseClient.From<Author>()
                .Select("id")
                .Get();
            totalAuthorsCount = authorsCountResponse.Models?.Count ?? 0;
        }
        catch
        {
            totalRecipesCount = 0;
            totalBooksCount = 0;
            totalAuthorsCount = 0;
        }
    }

    private void ShowRecipeDetails(Recipe recipe)
    {
        // Navigate to the recipe details page
        var uri = $"/recipes/{recipe.Id}";
        NavigationManager.NavigateTo(uri);
    }
    
    private void PrintRecipe(Recipe recipe)
    {
        NavigationManager.NavigateTo($"/recipes/{recipe.Id}/print");
    }
    
    private async Task ToggleFavorite(Recipe recipe)
    {
        await LocalStorage.ToggleFavoriteAsync(recipe.Id);
        
        // Refresh favorites list
        favoriteRecipeIds = await LocalStorage.GetFavoritesAsync();
        
        StateHasChanged();
        
        // Show toast notification
        var isFavorite = favoriteRecipeIds.Contains(recipe.Id);
        Snackbar.Add(
            isFavorite ? $"'{recipe.Name}' ajout√© aux favoris ‚ù§Ô∏è" : $"'{recipe.Name}' retir√© des favoris",
            isFavorite ? Severity.Success : Severity.Info
        );
    }

    private async Task ShowAddRecipeDialog()
    {
        var dialog = await DialogService.ShowAsync<AddRecipeDialog>("Ajouter une recette");
        var result = await dialog.Result;
        if (result is not null && !result.Canceled && result.Data is Recipe newRecipe)
        {
            // Refresh the recipes lists to include the new recipe
            await LoadNewestRecipes();
            await LoadRandomRecipes();
            await LoadCounts(); // Also refresh the counts
        }
    }
}
