@page "/stores/{Id:int}"
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Logging
@using MudBlazor
@using RecettesIndex.Models
@using RecettesIndex.Services
@using RecettesIndex.Components
@using Supabase
@inject AuthService AuthService
@inject IDialogService DialogService
@inject ILogger<StoreDetails> Logger
@inject NavigationManager NavigationManager
@inject Client SupabaseClient
@inject LocalStorageService LocalStorage
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>Magasin - @(store?.Name ?? "Chargement...")</PageTitle>
<MudBreadcrumbs Items="breadcrumbs" Class="mb-4" />

@if (loading)
{
    <MudContainer Class="d-flex flex-column align-center py-8">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        <MudText Typo="Typo.h6" Class="mt-4">Chargement du magasin...</MudText>
    </MudContainer>
}
else if (store == null)
{
    <MudAlert Severity="Severity.Error" Class="my-4">Magasin introuvable.</MudAlert>
}
else
{
    <HeroSection Title="@store.Name" 
                 Subtitle="@GetStoreInfo()"
                 AdditionalInfo="@store.Address"
                 Icon="@Icons.Material.Filled.Storefront">
        <RightContent>
            <MudChip T="string" Size="Size.Large" Class="hero-chip">
                @relatedRecipes.Count Recette@(relatedRecipes.Count > 1 ? "s" : "")
            </MudChip>
        </RightContent>
    </HeroSection>

    <ActionBar BackUrl="/stores" 
               BackText="Retour aux magasins"
               ShowEditButton="true"
               ShowPrintButton="false"
               IsAuthenticated="@AuthService.IsAuthenticated"
               OnEditClick="@OpenEditDialog" />

    <MudGrid>
        <MudItem xs="12">
            <MudCard Elevation="3">
                <MudCardContent>
                    <MudTabs Rounded="true" Elevation="2" ApplyEffectsToContainer="true">
                        <MudTabPanel Text="Informations" Icon="@Icons.Material.Filled.Info">
                            <MudPaper Elevation="0" Class="pa-4 mud-background-gray rounded-lg">
                                <MudStack Spacing="3">
                                    @if (!string.IsNullOrWhiteSpace(store.Address))
                                    {
                                        <div>
                                            <MudText Typo="Typo.subtitle2" Color="Color.Primary">
                                                <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                                                Adresse
                                            </MudText>
                                            <MudText Typo="Typo.body1" Class="ml-6">@store.Address</MudText>
                                        </div>
                                    }
                                    
                                    @if (!string.IsNullOrWhiteSpace(store.Phone))
                                    {
                                        <div>
                                            <MudText Typo="Typo.subtitle2" Color="Color.Primary">
                                                <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Class="mr-1" />
                                                T√©l√©phone
                                            </MudText>
                                            <MudText Typo="Typo.body1" Class="ml-6">
                                                <MudLink Href="@($"tel:{store.Phone}")">@store.Phone</MudLink>
                                            </MudText>
                                        </div>
                                    }
                                    
                                    @if (!string.IsNullOrWhiteSpace(store.Website))
                                    {
                                        <div>
                                            <MudText Typo="Typo.subtitle2" Color="Color.Primary">
                                                <MudIcon Icon="@Icons.Material.Filled.Language" Size="Size.Small" Class="mr-1" />
                                                Site Web
                                            </MudText>
                                            <MudText Typo="Typo.body1" Class="ml-6">
                                                <MudLink Href="@store.Website" Target="_blank">@store.Website</MudLink>
                                            </MudText>
                                        </div>
                                    }
                                    
                                    @if (!string.IsNullOrWhiteSpace(store.Notes))
                                    {
                                        <div>
                                            <MudText Typo="Typo.subtitle2" Color="Color.Primary">
                                                <MudIcon Icon="@Icons.Material.Filled.Notes" Size="Size.Small" Class="mr-1" />
                                                Notes
                                            </MudText>
                                            <MudText Typo="Typo.body1" Class="ml-6">@store.Notes</MudText>
                                        </div>
                                    }
                                    
                                    @if (string.IsNullOrWhiteSpace(store.Address) && string.IsNullOrWhiteSpace(store.Phone) && 
                                         string.IsNullOrWhiteSpace(store.Website) && string.IsNullOrWhiteSpace(store.Notes))
                                    {
                                        <MudAlert Severity="Severity.Info">Aucune information suppl√©mentaire disponible.</MudAlert>
                                    }
                                </MudStack>
                            </MudPaper>
                        </MudTabPanel>
                        <MudTabPanel Text="Recettes" Icon="@Icons.Material.Filled.Restaurant">
                            @if (relatedRecipes != null && relatedRecipes.Count > 0)
                            {
                                <MudGrid Spacing="3" Class="mt-4">
                                    @foreach (var recipe in relatedRecipes)
                                    {
                                        <MudItem xs="12" sm="6" md="4" lg="3">
                                            <RecipeCard Recipe="@recipe"
                                                       Store="@store"
                                                       IsAuthenticated="@AuthService.IsAuthenticated"
                                                       IsFavorite="@favoriteRecipeIds.Contains(recipe.Id)"
                                                       OnView="@ViewRecipe"
                                                       OnEdit="@(async (r) => await Task.CompletedTask)"
                                                       OnDelete="@(async (r) => await Task.CompletedTask)"
                                                       OnPrint="@PrintRecipe"
                                                       OnToggleFavorite="@ToggleFavorite" />
                                        </MudItem>
                                    }
                                </MudGrid>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info" Class="mt-3">Aucune recette trouv√©e pour ce magasin.</MudAlert>
                            }
                        </MudTabPanel>
                    </MudTabs>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
}

@code {
    [Parameter] 
    public int Id { get; set; }
    
    private Store? store;
    private bool loading = true;
    private readonly List<BreadcrumbItem> breadcrumbs =
    [
        new BreadcrumbItem("Accueil", href: "/"),
        new BreadcrumbItem("Magasins", href: "/stores"),
        new BreadcrumbItem("D√©tails", href: null, disabled: true)
    ];
    
    private List<Recipe> relatedRecipes = [];
    private List<int> favoriteRecipeIds = [];

    protected override void OnInitialized()
    {
        AuthService.AuthStateChanged += OnAuthStateChanged;
    }
    
    protected override async Task OnInitializedAsync()
    {
        // Load favorites from localStorage
        favoriteRecipeIds = await LocalStorage.GetFavoritesAsync();
        
        loading = true;
        
        try 
        {
            var response = await SupabaseClient.From<Store>().Where(x => x.Id == Id).Get();
            store = response.Models?.FirstOrDefault();
            
            if (store != null)
            {
                // Update the breadcrumbs with store name
                breadcrumbs[2] = new BreadcrumbItem(store.Name, href: null, disabled: true);
                
                // Get related recipes
                var recipesResponse = await SupabaseClient.From<Recipe>().Where(x => x.StoreId == store.Id).Get();
                relatedRecipes = recipesResponse.Models ?? new List<Recipe>();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading store {StoreId}", Id);
        }
        finally
        {
            loading = false;
        }
    }
    
    private void ViewRecipe(Recipe recipe)
    {
        NavigationManager.NavigateTo($"/recipes/{recipe.Id}");
    }
    
    private void PrintRecipe(Recipe recipe)
    {
        NavigationManager.NavigateTo($"/recipes/{recipe.Id}/print");
    }
    
    private async Task ToggleFavorite(Recipe recipe)
    {
        await LocalStorage.ToggleFavoriteAsync(recipe.Id);
        
        // Refresh favorites list
        favoriteRecipeIds = await LocalStorage.GetFavoritesAsync();
        
        StateHasChanged();
        
        // Show toast notification
        var isFavorite = favoriteRecipeIds.Contains(recipe.Id);
        Snackbar.Add(
            isFavorite ? $"'{recipe.Name}' ajout√© aux favoris ‚ù§Ô∏è" : $"'{recipe.Name}' retir√© des favoris",
            isFavorite ? Severity.Success : Severity.Info
        );
    }
    
    private async Task OpenEditDialog()
    {
        if (store != null)
        {
            var parameters = new DialogParameters();
            parameters.Add("StoreToEdit", store);
            
            var dialog = await DialogService.ShowAsync<EditStoreDialog>("Modifier le magasin", parameters);
            var result = await dialog.Result;
            
            if (result is not null && !result.Canceled && result.Data is Store updatedStore)
            {
                // Refresh the store data
                store = updatedStore;
                StateHasChanged();
            }
        }
    }

    private string GetStoreInfo()
    {
        var info = new List<string>();
        
        if (!string.IsNullOrWhiteSpace(store?.Phone))
        {
            info.Add($"üìû {store.Phone}");
        }
        
        if (!string.IsNullOrWhiteSpace(store?.Website))
        {
            info.Add("üåê Site web");
        }

        return string.Join(" ‚Ä¢ ", info);
    }

    private void OnAuthStateChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AuthService.AuthStateChanged -= OnAuthStateChanged;
    }
}
