@page "/dashboard"
@using MudBlazor
@using RecettesIndex.Models
@using RecettesIndex.Services
@using RecettesIndex.Services.Abstractions
@using Microsoft.Extensions.Logging
@inject IRecipeService RecipeService
@inject NavigationManager NavigationManager
@inject ILogger<Dashboard> Logger

<PageTitle>Tableau de Bord - Mes Recettes</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-6">
        <MudIcon Icon="@Icons.Material.Filled.BarChart" Color="Color.Primary" Style="font-size: 2rem;" />
        <MudText Typo="Typo.h4">Tableau de Bord</MudText>
    </MudStack>
    
    @if (loading)
    {
        <div class="d-flex justify-center my-8">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else
    {
        <!-- Summary Stats Cards -->
        <MudGrid Class="mb-6">
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="3" Class="pa-4 rounded-lg h-100">
                    <MudStack Spacing="2" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Restaurant" Color="Color.Primary" Size="Size.Large" />
                        <MudText Typo="Typo.h3" Align="Align.Center">@statistics.TotalRecipes</MudText>
                        <MudText Typo="Typo.subtitle1" Align="Align.Center" Color="Color.Primary">Recettes Totales</MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>
            
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="3" Class="pa-4 rounded-lg h-100">
                    <MudStack Spacing="2" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.AutoStories" Color="Color.Secondary" Size="Size.Large" />
                        <MudText Typo="Typo.h3" Align="Align.Center">@statistics.TotalBooks</MudText>
                        <MudText Typo="Typo.subtitle1" Align="Align.Center" Color="Color.Secondary">Livres de Recettes</MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>
            
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="3" Class="pa-4 rounded-lg h-100">
                    <MudStack Spacing="2" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Storefront" Color="Color.Info" Size="Size.Large" />
                        <MudText Typo="Typo.h3" Align="Align.Center">@statistics.TotalStores</MudText>
                        <MudText Typo="Typo.subtitle1" Align="Align.Center" Color="Color.Info">Magasins/Restaurants</MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>
            
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Elevation="3" Class="pa-4 rounded-lg h-100">
                    <MudStack Spacing="2" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Large" />
                        <MudText Typo="Typo.h3" Align="Align.Center">@statistics.AverageRating.ToString("F1")</MudText>
                        <MudText Typo="Typo.subtitle1" Align="Align.Center" Color="Color.Warning">Note Moyenne</MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- Charts Section -->
        <MudGrid Class="mb-6">
            <!-- Rating Distribution Chart -->
            <MudItem xs="12" md="6">
                <MudPaper Elevation="2" Class="pa-4 rounded-lg h-100">
                    <MudText Typo="Typo.h5" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.PieChart" Class="mr-2" />
                        Distribution des Notes
                    </MudText>
                    @if (ratingChartData.Any())
                    {
                        <MudChart ChartType="ChartType.Donut" Width="300px" Height="300px" 
                                InputData="@ratingChartData" InputLabels="@ratingChartLabels"
                                ChartOptions="@(new ChartOptions { ChartPalette = new[] { "#4CAF50", "#2196F3", "#FFC107", "#FF9800", "#F44336" } })">
                        </MudChart>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">Pas assez de données pour le graphique.</MudAlert>
                    }
                </MudPaper>
            </MudItem>

            <!-- Activity Trend Chart -->
            <MudItem xs="12" md="6">
                <MudPaper Elevation="2" Class="pa-4 rounded-lg h-100">
                    <MudText Typo="Typo.h5" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.ShowChart" Class="mr-2" />
                        Activité (6 derniers mois)
                    </MudText>
                    @if (trendSeries.Any())
                    {
                        <MudChart ChartType="ChartType.Line" ChartSeries="@trendSeries" XAxisLabels="@trendXAxisLabels" Width="100%" Height="300px"
                                ChartOptions="@(new ChartOptions { YAxisLines = true })"></MudChart>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">Pas assez de données pour le graphique.</MudAlert>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- Top Rated Recipes & Recent Activity -->
        <MudGrid Class="mb-6">
            <MudItem xs="12" md="6">
                <MudPaper Elevation="2" Class="pa-4 rounded-lg h-100">
                    <MudText Typo="Typo.h5" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Star" Class="mr-2" />
                        Meilleures Recettes
                    </MudText>
                    
                    @if (statistics.TopRatedRecipes.Any())
                    {
                        <MudList T="string" Dense="true">
                            @foreach (var recipe in statistics.TopRatedRecipes)
                            {
                                <MudListItem OnClick="@(() => NavigateToRecipe(recipe.Id))">
                                    <div class="d-flex justify-space-between align-center">
                                        <MudText>@recipe.Name</MudText>
                                        <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                                            <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Small" />
                                            <MudText>@recipe.Rating</MudText>
                                        </MudStack>
                                    </div>
                                </MudListItem>
                            }
                        </MudList>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">Aucune recette évaluée pour le moment.</MudAlert>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudPaper Elevation="2" Class="pa-4 rounded-lg h-100">
                    <MudText Typo="Typo.h5" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Schedule" Class="mr-2" />
                        Activité Récente
                    </MudText>
                    
                    <MudList T="string" Dense="true">
                        <MudListItem>
                            <MudText Typo="Typo.subtitle2" Color="Color.Primary">Dernière recette ajoutée</MudText>
                            @if (statistics.MostRecentRecipe != null)
                            {
                                <MudLink OnClick="@(() => NavigateToRecipe(statistics.MostRecentRecipe.Id))">
                                    @statistics.MostRecentRecipe.Name
                                </MudLink>
                                <MudText Typo="Typo.caption" Class="ml-2">
                                    @statistics.MostRecentRecipe.CreationDate.ToString("d MMM yyyy")
                                </MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2">Aucune recette</MudText>
                            }
                        </MudListItem>
                        <MudDivider />
                        <MudListItem>
                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Dernier livre ajouté</MudText>
                            @if (statistics.MostRecentBook != null)
                            {
                                <MudLink OnClick="@(() => NavigateToBook(statistics.MostRecentBook.Id))">
                                    @statistics.MostRecentBook.Name
                                </MudLink>
                                <MudText Typo="Typo.caption" Class="ml-2">
                                    @statistics.MostRecentBook.CreationDate.ToString("d MMM yyyy")
                                </MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2">Aucun livre</MudText>
                            }
                        </MudListItem>
                        <MudDivider />
                        <MudListItem>
                            <div class="d-flex justify-space-between">
                                <MudText>Recettes (7 jours)</MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Info">@statistics.RecipesAddedLast7Days</MudChip>
                            </div>
                        </MudListItem>
                        <MudListItem>
                            <div class="d-flex justify-space-between">
                                <MudText>Recettes (30 jours)</MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Warning">@statistics.RecipesAddedLast30Days</MudChip>
                            </div>
                        </MudListItem>
                    </MudList>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- Book, Store, and Author Statistics -->
        <MudGrid Class="mb-6">
            <MudItem xs="12" md="4">
                <MudPaper Elevation="2" Class="pa-4 rounded-lg">
                    <MudText Typo="Typo.h5" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.AutoStories" Class="mr-2" />
                        Livres Populaires
                    </MudText>
                    
                    @if (statistics.MostUsedBooks.Any())
                    {
                        <MudList T="string" Dense="true">
                            @foreach (var bookStat in statistics.MostUsedBooks.Take(5))
                            {
                                <MudListItem OnClick="@(() => NavigateToBook(bookStat.BookId))">
                                    <div class="d-flex justify-space-between">
                                        <MudText Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@bookStat.BookName</MudText>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary">@bookStat.RecipeCount</MudChip>
                                    </div>
                                </MudListItem>
                            }
                        </MudList>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">Aucun livre enregistré.</MudAlert>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Elevation="2" Class="pa-4 rounded-lg">
                    <MudText Typo="Typo.h5" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Storefront" Class="mr-2" />
                        Magasins Populaires
                    </MudText>
                    
                    @if (statistics.MostUsedStores.Any())
                    {
                        <MudList T="string" Dense="true">
                            @foreach (var storeStat in statistics.MostUsedStores.Take(5))
                            {
                                <MudListItem OnClick="@(() => NavigateToStore(storeStat.StoreId))">
                                    <div class="d-flex justify-space-between">
                                        <MudText Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@storeStat.StoreName</MudText>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@storeStat.RecipeCount</MudChip>
                                    </div>
                                </MudListItem>
                            }
                        </MudList>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">Aucun magasin enregistré.</MudAlert>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Elevation="2" Class="pa-4 rounded-lg">
                    <MudText Typo="Typo.h5" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Class="mr-2" />
                        Auteurs Populaires
                    </MudText>
                    
                    @if (statistics.MostUsedAuthors.Any())
                    {
                        <MudList T="string" Dense="true">
                            @foreach (var authorStat in statistics.MostUsedAuthors.Take(5))
                            {
                                <MudListItem OnClick="@(() => NavigateToAuthor(authorStat.AuthorId))">
                                    <div class="d-flex justify-space-between">
                                        <MudText Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@authorStat.AuthorName</MudText>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Tertiary">@authorStat.RecipeCount</MudChip>
                                    </div>
                                </MudListItem>
                            }
                        </MudList>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">Aucun auteur enregistré.</MudAlert>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- Quick Actions -->
        <MudPaper Elevation="2" Class="pa-4 rounded-lg">
            <MudText Typo="Typo.h5" Class="mb-4">Actions Rapides</MudText>
            <MudStack Row Wrap="Wrap.Wrap" Spacing="2">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Restaurant"
                          Href="/recipes">
                    Voir toutes les recettes
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Warning" 
                          StartIcon="@Icons.Material.Filled.Star"
                          Href="/recipes?filter=5stars">
                    Recettes 5 étoiles
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Secondary" 
                          StartIcon="@Icons.Material.Filled.AutoStories"
                          Href="/books">
                    Gérer les livres
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Info" 
                          StartIcon="@Icons.Material.Filled.Storefront"
                          Href="/stores">
                    Gérer les magasins
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Tertiary" 
                          StartIcon="@Icons.Material.Filled.Person"
                          Href="/authors">
                    Gérer les auteurs
                </MudButton>
            </MudStack>
        </MudPaper>
    }
</MudContainer>

@code {
    private bool loading = true;
    private DashboardStatistics statistics = new();
    
    // Chart Data
    private double[] ratingChartData = Array.Empty<double>();
    private string[] ratingChartLabels = Array.Empty<string>();
    private List<ChartSeries> trendSeries = new();
    private string[] trendXAxisLabels = Array.Empty<string>();

    protected override async Task OnInitializedAsync()
    {
        await LoadStatistics();
    }

    private async Task LoadStatistics()
    {
        loading = true;
        try
        {
            var (recipes, books, authors, stores) = await LoadBaseDataAsync();
            
            if (recipes == null)
            {
                statistics = new DashboardStatistics();
                return;
            }

            CalculateBasicStatistics(recipes, books, authors, stores);
            CalculateRatingStatistics(recipes);
            CalculateTopRatedRecipes(recipes);
            CalculateBookStatistics(recipes, books);
            CalculateStoreStatistics(recipes, stores);
            CalculateAuthorStatistics(recipes, books, authors);
            CalculateRecentActivity(recipes, books);
            
            // Prepare Chart Data
            PrepareCharts(recipes);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading dashboard statistics");
            statistics = new DashboardStatistics();
        }
        finally
        {
            loading = false;
        }
    }

    private void PrepareCharts(List<Recipe> recipes)
    {
        // 1. Rating Donut Chart
        var ratings = recipes
            .Where(r => r.Rating > 0)
            .GroupBy(r => r.Rating)
            .OrderByDescending(g => g.Key) // 5 stars first
            .ToList();
            
        ratingChartData = ratings.Select(g => (double)g.Count()).ToArray();
        ratingChartLabels = ratings.Select(g => $"{g.Key}★ ({g.Count()})").ToArray();

        // 2. Trend Line Chart (Last 6 months)
        var now = DateTime.UtcNow;
        var last6Months = Enumerable.Range(0, 6)
            .Select(i => now.AddMonths(-5 + i))
            .ToList();
        
        var monthlyData = last6Months.Select(month => 
            (double)recipes.Count(r => r.CreationDate.Month == month.Month && r.CreationDate.Year == month.Year)
        ).ToArray();

        trendSeries = new List<ChartSeries>
        {
            new ChartSeries { Name = "Recettes Ajoutées", Data = monthlyData }
        };
        trendXAxisLabels = last6Months.Select(d => d.ToString("MMM")).ToArray();
    }

    private async Task<(List<Recipe>? recipes, IReadOnlyList<Book> books, IReadOnlyList<Author> authors, IReadOnlyList<Store> stores)> LoadBaseDataAsync()
    {
        var recipesResult = await RecipeService.SearchAsync(null, null, null, null, null, 1, 10000);
        var books = await RecipeService.GetBooksAsync();
        var authors = await RecipeService.GetAuthorsAsync();
        var stores = await RecipeService.GetStoresAsync();

        if (!recipesResult.IsSuccess)
        {
            Logger.LogWarning("Failed to load recipes for dashboard: {Error}", recipesResult.ErrorMessage);
            return (null, books, authors, stores);
        }

        return (recipesResult.Value.Items.ToList(), books, authors, stores);
    }

    private void CalculateBasicStatistics(List<Recipe> recipes, IReadOnlyList<Book> books, IReadOnlyList<Author> authors, IReadOnlyList<Store> stores)
    {
        statistics.TotalRecipes = recipes.Count;
        statistics.TotalBooks = books.Count;
        statistics.TotalAuthors = authors.Count;
        statistics.TotalStores = stores.Count;
    }

    private void CalculateRatingStatistics(List<Recipe> recipes)
    {
        var ratedRecipes = recipes.Where(r => r.Rating > 0).ToList();
        
        statistics.AverageRating = ratedRecipes.Any() 
            ? ratedRecipes.Average(r => r.Rating) 
            : 0;

        statistics.RatingDistribution = ratedRecipes
            .GroupBy(r => r.Rating)
            .ToDictionary(g => g.Key, g => g.Count());

        statistics.UnratedCount = recipes.Count(r => r.Rating == 0);
    }

    private void CalculateTopRatedRecipes(List<Recipe> recipes)
    {
        statistics.TopRatedRecipes = recipes
            .Where(r => r.Rating > 0)
            .OrderByDescending(r => r.Rating)
            .ThenByDescending(r => r.CreationDate)
            .Take(5)
            .ToList();
    }

    private void CalculateBookStatistics(List<Recipe> recipes, IReadOnlyList<Book> books)
    {
        statistics.MostUsedBooks = recipes
            .Where(r => r.BookId.HasValue)
            .GroupBy(r => r.BookId!.Value)
            .Select(g => new BookStatistic
            {
                BookId = g.Key,
                BookName = books.FirstOrDefault(b => b.Id == g.Key)?.Name ?? "Unknown",
                RecipeCount = g.Count()
            })
            .OrderByDescending(b => b.RecipeCount)
            .ToList();
    }

    private void CalculateStoreStatistics(List<Recipe> recipes, IReadOnlyList<Store> stores)
    {
        statistics.MostUsedStores = recipes
            .Where(r => r.StoreId.HasValue)
            .GroupBy(r => r.StoreId!.Value)
            .Select(g => new StoreStatistic
            {
                StoreId = g.Key,
                StoreName = stores.FirstOrDefault(s => s.Id == g.Key)?.Name ?? "Unknown",
                RecipeCount = g.Count()
            })
            .OrderByDescending(s => s.RecipeCount)
            .ToList();
    }

    private void CalculateAuthorStatistics(List<Recipe> recipes, IReadOnlyList<Book> books, IReadOnlyList<Author> authors)
    {
        var authorRecipeCounts = new Dictionary<int, int>();
        
        foreach (var author in authors)
        {
            var authorBookIds = books
                .Where(b => b.Authors.Any(a => a.Id == author.Id))
                .Select(b => b.Id)
                .ToHashSet();
            
            var count = recipes.Count(r => r.BookId.HasValue && authorBookIds.Contains(r.BookId.Value));
            if (count > 0)
            {
                authorRecipeCounts[author.Id] = count;
            }
        }

        statistics.MostUsedAuthors = authorRecipeCounts
            .Select(kvp => new AuthorStatistic
            {
                AuthorId = kvp.Key,
                AuthorName = authors.FirstOrDefault(a => a.Id == kvp.Key)?.FullName ?? "Unknown",
                RecipeCount = kvp.Value
            })
            .OrderByDescending(a => a.RecipeCount)
            .ToList();
    }

    private void CalculateRecentActivity(List<Recipe> recipes, IReadOnlyList<Book> books)
    {
        statistics.MostRecentRecipe = recipes
            .OrderByDescending(r => r.CreationDate)
            .FirstOrDefault();

        statistics.MostRecentBook = books
            .OrderByDescending(b => b.CreationDate)
            .FirstOrDefault();

        var now = DateTime.UtcNow;
        statistics.RecipesAddedLast7Days = recipes
            .Count(r => r.CreationDate >= now.AddDays(-7));
        
        statistics.RecipesAddedLast30Days = recipes
            .Count(r => r.CreationDate >= now.AddDays(-30));
    }

    private void NavigateToRecipe(int id) => NavigationManager.NavigateTo($"/recipes/{id}");
    private void NavigateToBook(int id) => NavigationManager.NavigateTo($"/books/{id}");
    private void NavigateToStore(int id) => NavigationManager.NavigateTo($"/stores/{id}");
    private void NavigateToAuthor(int id) => NavigationManager.NavigateTo($"/authors/{id}");

}
