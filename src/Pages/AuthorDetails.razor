@page "/authors/{Id:int}"
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Logging
@using MudBlazor
@using RecettesIndex.Models
@using RecettesIndex.Services
@using RecettesIndex.Components
@using Supabase.Postgrest
@using SupabaseClient = Supabase.Client
@inject AuthService AuthService
@inject IDialogService DialogService
@inject ILogger<AuthorDetails> Logger
@inject NavigationManager NavigationManager
@inject SupabaseClient SupabaseClient
@inject LocalStorageService LocalStorage
@inject ISnackbar Snackbar

<PageTitle>Auteur - @(author?.FullName ?? "Chargement...")</PageTitle>
<MudBreadcrumbs Items="breadcrumbs" Class="mb-4" />

@if (loading)
{
    <MudContainer Class="d-flex flex-column align-center py-8">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        <MudText Typo="Typo.h6" Class="mt-4">Chargement de l'auteur...</MudText>
    </MudContainer>
}
else if (author == null)
{
    <MudAlert Severity="Severity.Error" Class="my-4">Auteur introuvable.</MudAlert>
}
else
{
    <HeroSection Title="@($"{author.Name} {author.LastName}")" 
                 Subtitle="@GetAuthorInfo()"
                 AdditionalInfo=""
                 Icon="@Icons.Material.Filled.Person">
        <RightContent>
            <div class="d-flex flex-column align-center">
                <MudChip T="string" Size="Size.Large" Class="mb-2 hero-chip">
                    @books.Count Livre@(books.Count > 1 ? "s" : "")
                </MudChip>
                <MudChip T="string" Size="Size.Large" Class="hero-chip">
                    @relatedRecipes.Count Recette@(relatedRecipes.Count > 1 ? "s" : "")
                </MudChip>
            </div>
        </RightContent>
    </HeroSection>

    <ActionBar BackUrl="/authors" 
               BackText="Retour aux auteurs"
               ShowEditButton="true"
               ShowPrintButton="false"
               IsAuthenticated="@AuthService.IsAuthenticated"
               OnEditClick="@OpenEditDialog" />

    <MudGrid>
        <MudItem xs="12">
            <MudCard Elevation="3">
                <MudCardContent>
                    <MudTabs Rounded="true" Elevation="2" ApplyEffectsToContainer="true">
                        <MudTabPanel Text="Livres" Icon="@Icons.Material.Filled.Book">
                            @if (books != null && books.Count > 0)
                            {
                                <MudPaper Elevation="0" Class="pa-2">
                                    <MudGrid>
                                        @foreach (var book in books)
                                        {
                                            <MudItem xs="12" sm="6" md="4">
                                                <MudCard Elevation="2" Class="ma-2 book-card">
                                                    <MudCardHeader>
                                                        <CardHeaderAvatar>
                                                            <MudAvatar Color="Color.Tertiary" Size="Size.Small">
                                                                <MudIcon Icon="@Icons.Material.Filled.Book" />
                                                            </MudAvatar>
                                                        </CardHeaderAvatar>
                                                        <CardHeaderContent>
                                                            <MudText Typo="Typo.h6">@book.Name</MudText>
                                                        </CardHeaderContent>
                                                    </MudCardHeader>
                                                    <MudCardContent>
                                                        <MudText Typo="Typo.body2">Créé le: @book.CreationDate.ToShortDateString()</MudText>
                                                        @{
                                                            var recipeCount = relatedRecipes.Count(r => r.BookId == book.Id);
                                                        }
                                                        <MudText Typo="Typo.body2">Recettes: @recipeCount</MudText>
                                                    </MudCardContent>
                                                    <MudCardActions>
                                                        <MudButton Variant="Variant.Text" Color="Color.Primary" 
                                                                Href="@($"/books/{book.Id}")">
                                                            Voir le livre
                                                        </MudButton>
                                                    </MudCardActions>
                                                </MudCard>
                                            </MudItem>
                                        }
                                    </MudGrid>
                                </MudPaper>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info" Class="mt-3">Cet auteur n'a pas de livres.</MudAlert>
                            }
                        </MudTabPanel>
                        <MudTabPanel Text="Recettes" Icon="@Icons.Material.Filled.Restaurant">
                            <!-- Search Bar -->
                            @if (relatedRecipes != null && relatedRecipes.Count > 0)
                            {
                                <MudPaper Elevation="0" Class="pa-4 mb-4">
                                    <MudTextField T="string" 
                                                ValueChanged="@(s => FilterRecipes(s))" 
                                                Placeholder="Rechercher une recette..." 
                                                Adornment="Adornment.Start" 
                                                AdornmentIcon="@Icons.Material.Filled.Search" 
                                                IconSize="Size.Medium"
                                                FullWidth="true" />
                                </MudPaper>
                            }
                            
                            @if (filteredRecipes != null && filteredRecipes.Count > 0)
                            {
                                <MudGrid Spacing="3" Class="mt-2">
                                    @foreach (var recipe in filteredRecipes)
                                    {
                                        var recipeBook = books.FirstOrDefault(b => b.Id == recipe.BookId);
                                        <MudItem xs="12" sm="6" md="4" lg="3">
                                            <RecipeCard Recipe="@recipe"
                                                       Book="@recipeBook"
                                                       IsAuthenticated="@AuthService.IsAuthenticated"
                                                       IsFavorite="@favoriteRecipeIds.Contains(recipe.Id)"
                                                       OnView="@ViewRecipe"
                                                       OnEdit="@(async (r) => await Task.CompletedTask)"
                                                       OnDelete="@(async (r) => await Task.CompletedTask)"
                                                       OnPrint="@PrintRecipe"
                                                       OnToggleFavorite="@ToggleFavorite" />
                                        </MudItem>
                                    }
                                </MudGrid>
                            }
                            else if (relatedRecipes != null && relatedRecipes.Count > 0)
                            {
                                <MudAlert Severity="Severity.Info" Class="mt-3">Aucune recette ne correspond à votre recherche.</MudAlert>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info" Class="mt-3">Aucune recette trouvée de cet auteur.</MudAlert>
                            }
                        </MudTabPanel>
                    </MudTabs>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
}

@code {
    [Parameter] 
    public int Id { get; set; }
    
    private Author? author;
    private bool loading = true;
    private List<BreadcrumbItem> breadcrumbs =
    [
        new BreadcrumbItem("Accueil", href: "/"),
        new BreadcrumbItem("Auteurs", href: "/authors"),
        new BreadcrumbItem("Détails", href: null, disabled: true)
    ];
    
    private List<Book> books = [];
    private List<Recipe> relatedRecipes = [];
    private List<Recipe> filteredRecipes = [];
    private List<int> favoriteRecipeIds = [];
    private string searchString = "";
    
    protected override async Task OnInitializedAsync()
    {
        // Load favorites from localStorage
        favoriteRecipeIds = await LocalStorage.GetFavoritesAsync();
        
        loading = true;
        
        try 
        {
            var response = await SupabaseClient.From<Author>().Where(x => x.Id == Id).Get();
            author = response.Models?.FirstOrDefault();
            
            if (author != null)
            {
                // Update the breadcrumbs with author name
                breadcrumbs[2] = new BreadcrumbItem($"{author.Name} {author.LastName}", href: null, disabled: true);
                
                // Get related books
                var result = await SupabaseClient.From<Recipe>()
                      .Select("*, book_id_info:books(authors!inner(id))")
                      .Filter("book_id_info.authors.id", Constants.Operator.Equals, Id)
                      .Get();
                
                relatedRecipes = result
                     .Models
                     .Where(x => x.Book != null && x.Book.Authors.Any(a => a.Id == Id)).ToList();
                
                filteredRecipes = relatedRecipes;
                
                // Extract unique books from the recipes
                books = relatedRecipes
                    .Where(r => r.Book != null)
                    .Select(r => r.Book!)
                    .GroupBy(b => b.Id)
                    .Select(g => g.First())
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            // Add error handling if needed
            Logger.LogError(ex, "Error loading author {AuthorId}", Id);
        }
        finally
        {
            loading = false;
        }
    }
    
    private void FilterRecipes(string searchText)
    {
        searchString = searchText;
        if (string.IsNullOrWhiteSpace(searchText))
        {
            filteredRecipes = relatedRecipes;
        }
        else
        {
            filteredRecipes = relatedRecipes.Where(r => 
                r.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                (r.Book?.Name?.Contains(searchText, StringComparison.OrdinalIgnoreCase) == true) ||
                (r.Notes?.Contains(searchText, StringComparison.OrdinalIgnoreCase) == true)
            ).ToList();
        }
    }
    
    private void ViewRecipe(Recipe recipe)
    {
        NavigationManager.NavigateTo($"/recipes/{recipe.Id}");
    }
    
    private void PrintRecipe(Recipe recipe)
    {
        NavigationManager.NavigateTo($"/recipes/{recipe.Id}/print");
    }
    
    private async Task ToggleFavorite(Recipe recipe)
    {
        await LocalStorage.ToggleFavoriteAsync(recipe.Id);
        
        // Refresh favorites list
        favoriteRecipeIds = await LocalStorage.GetFavoritesAsync();
        
        StateHasChanged();
        
        // Show toast notification
        var isFavorite = favoriteRecipeIds.Contains(recipe.Id);
        Snackbar.Add(
            isFavorite ? $"'{recipe.Name}' ajouté aux favoris ❤️" : $"'{recipe.Name}' retiré des favoris",
            isFavorite ? Severity.Success : Severity.Info
        );
    }
    
    private async Task OpenEditDialog()
    {
        if (author != null)
        {
            var parameters = new DialogParameters();
            parameters.Add("AuthorToEdit", author);
            
            var dialog = await DialogService.ShowAsync<EditAuthorDialog>("Modifier l'auteur", parameters);
            var result = await dialog.Result;
            
            if (result is not null && !result.Canceled && result.Data is Author updatedAuthor)
            {
                // Refresh the author data
                author = updatedAuthor;
                StateHasChanged();
            }
        }
    }

    private string GetAuthorInfo()
    {
        var info = new List<string>();
        
        if (books.Any())
        {
            var ratedRecipes = relatedRecipes.Where(r => r.Rating > 0).ToList();
            
            if (ratedRecipes.Any())
            {
                var avgRating = ratedRecipes.Average(r => r.Rating);
                info.Add($"Moyenne des évaluations: {avgRating:F1}/5");
            }
        }

        return string.Join(" • ", info);
    }
}
